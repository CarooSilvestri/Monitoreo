'MONITOREO SLC/DPC 7.0 020618
'MONITOREO PARA SLC - Despacho CUÀDRUPLEX

'ACTUALIZAR MENU "CONFIGURACION DE SISTEMA"

'***************************************************************************************************
'status guarda info recibida de cada ascensor (SLC o del Despacho)
'Si es simplex recibe: nro equipo + 40 bytes asc + EOF - Total: 42 bytes
'Si es grupo recibe 5 paquetes de 94 bytes:
'El primer paquete trae 93 bytes útiles de info de grupo
'Los paquetes 1 a 4 traen 81 bytes de info de cada ascensor
'ATENCIÓN: NO HAY CHECKSUM DESDE NI HACIA PC!!!
'
' DIM VA DE 0 A N (DIM XX(7)= 0 A 7, 8 ELEMENTOS)
'
'***************************************************************************************************

Option Explicit

Dim t_llam_subir_act(28), t_llam_bajar_act(28), t_llam_cabina_act(4, 28) As Long
Dim t_manual_act(4) As Long
Dim t_marcha_act(4), t_marcha_acum(4) As Long

Dim OKrecibido, dato, j, z, paradas, grupo, paquete0, paquete1, paquete2, paquete3, paquete4 As Byte
Dim colocarllamada(4) As Byte
Dim aenviaraslc(57) As Byte     'ENVIA 58 BYTES MÁXIMO (CUANDO ES DPC) A INTERFAZ PC VÍA RS232


Dim recibido(4, 93) As Integer    'DATOS RECIBIDOS DE INTERFAZ - 5x94 BYTES (0 A 93)
                                  'EN INDICE 0 VAN LOS DATOS DE GRUPO (PRIMERPAQUETEENVIADO POR INTERFAZ PC)
Dim status(4, 81) As Integer      '4 ASCENSORES - 82 BYTES DE INFO CADA UNO (0 a 81)
Dim previewstatus(4, 81) As Integer     'ACÁ GUARDA LO RECIBIDO PARA VER SI LLEGÓ NUEVA INFO EN CICLO SIGUIENTE
Dim llamexteriores1(7) As Integer       '8 ELEMENTOS
Dim previewllamadas1(7) As Integer      '8 ELEMENTOS
Dim llamexteriores2(7) As Integer       '8 ELEMENTOS
Dim previewllamadas2(7) As Integer      '8 ELEMENTOS
Dim fallaexteriores1(7) As Integer      '8 ELEMENTOS
Dim previewfalladas1(7) As Integer      '8 ELEMENTOS
Dim fallaexteriores2(7) As Integer      '8 ELEMENTOS
Dim previewfalladas2(7) As Integer      '8 ELEMENTOS
Dim accionL1(4) As Integer              '5 ELEMENTOS (ES MAS CÒMODO USAR DE 1 A 4 POR LOS NROS DE ASCENSOR)
Dim accionL2(4) As Integer              '5 ELEMENTOS (ES MAS CÒMODO USAR DE 1 A 4 POR LOS NROS DE ASCENSOR)
Dim previewaccionL1(4) As Integer         '5 ELEMENTOS
Dim previewaccionL2(4) As Integer         '5 ELEMENTOS

Dim i, k, l, m, n, o, p, r, u, w, w4, z4, x, zz, setcom, codigoerror, previeweventoDPC, SinCom As Integer
Dim s, buffer, textoerror As String
Dim piso, tipo, tiempo, fecha, hora As String
Dim ascensor, evento As String
Dim bit0, bit1, bit2, bit3, bit4, bit5, bit6, bit7 As Byte


Public Sub Form_Load()
On Local Error GoTo errorhandler

ChDir ("c:\Users\PC\Documents\Monitoreo 7_3 051218")

' UBICA LAS CABINAS
Picture1(0).Left = 3120
Picture1(0).Top = 7560
Picture17(0).Left = 3120
Picture17(0).Top = 7440

Picture1(1).Left = 5520
Picture1(1).Top = 7560
Picture17(1).Left = 5520
Picture17(1).Top = 7440

Picture1(2).Left = 7920
Picture1(2).Top = 7560
Picture17(2).Left = 7920
Picture17(2).Top = 7440

Picture1(3).Left = 10320
Picture1(3).Top = 7560
Picture17(3).Left = 10320
Picture17(3).Top = 7440

' SOLO PRUEBA DE LINEA
'Line (3000, 7440)-(3900, 7200), RGB(255, 0, 0)


' Inicializa el control Comm
Open "Configuracion sistema.dat" For Input As #7
Input #7, setcom
Input #7, paradas
Input #7, grupo

Close #7

MSComm1.CommPort = setcom
MSComm1.Settings = "38400,n,8,2"
Debug.Print "----------------"

If grupo = 1 Then
                'Si es simplex, recibe 56 bytes y dispara OnComm event
                MSComm1.InBufferSize = 56
                MSComm1.RThreshold = 56

                MSComm1.OutBufferSize = 16
                MSComm1.SThreshold = 0      '16  Si es 0 nunca dispara oncommevent al transmitir
             Else
                'Si es GRUPO, recibe 470 bytes y dispara OnComm event (OJO! NO VIENE CHECKSUM)
                MSComm1.InBufferSize = 470
                MSComm1.RThreshold = 470

                MSComm1.OutBufferSize = 58  'TRANSMITE 58 BYTES - OJO! NO VA CHECKSUM
                MSComm1.SThreshold = 0      '16  Si es 0 nunca dispara oncommevent al transmitir
End If

' Abre el puerto
MSComm1.PortOpen = True

'Limpia el buffer de entrada
For i = MSComm1.InBufferCount To 0 Step -1
s = MSComm1.Input
Next i

buffer = ""

' Lee de a 1 byte por vez luego de OnComm event
MSComm1.InputLen = 1

'Pinta marcador de espera de RX color amarillo (estado inicial)
Shape1.FillColor = QBColor(6)
'Pinta marcador de RX recibida color negro (estado inicial)
Shape2.FillColor = QBColor(0)
'Pinta marcador de paquete recibido OK color negro (estado inicial)
Shape3.FillColor = QBColor(0)

t_manual_act(0) = 0
t_manual_act(1) = 0
t_manual_act(2) = 0
t_manual_act(3) = 0

OKrecibido = 0

' LIMPIA ARRAY DONDE GUARDA DATOS RECIBIDOS EN CICLO ANTERIOR
For j = 0 To 4
For i = 0 To 80
previewstatus(j, i) = 0
Next i
Next j

For i = 0 To 7
llamexteriores1(i) = 0
previewllamadas1(i) = 0
fallaexteriores1(i) = 0
previewfalladas1(i) = 55           'Cualquier valor
llamexteriores2(i) = 0
previewllamadas2(i) = 0
fallaexteriores2(i) = 0
previewfalladas2(i) = 55           'Cualquier valor
Next i

' Carga cualquier cosa en preview de evento (254 porque si el primer evento es 0 o 255 no lo reconoce como nuevo)
previewstatus(1, 23) = 254
previewstatus(2, 23) = 254
previewstatus(3, 23) = 254
previewstatus(4, 23) = 254
previeweventoDPC = 254

For i = 1 To 4
For j = 1 To 28
t_llam_cabina_act(i, j) = 0
Next j
Next i


For i = 0 To 57
aenviaraslc(i) = 0
Next i

' APAGA TODOS LOS MENUES DE CONFIGURACION
Frame1.Visible = False
Frame3.Visible = False
Frame4.Visible = False
Frame5.Visible = False

Label5.Caption = "Sin Com"


'ABRE EL ARCHIVO DE CONFIGURACION DEL ASCENSOR. SI NO EXISTE, LO CREA AQUI
If grupo = 1 Then
    If Dir("Configuracion ascensor 1.dat") = "" Then
                Open "Configuracion ascensor 1.dat" For Output As #1
                Write #1, 1             'NÙMERO DE ASCENSOR
                For i = 1 To 56
                Write #1, 0
                aenviaraslc(i) = 0
                Next i
                Close #1
            Else
                Open "Configuracion ascensor 1.dat" For Input As #1
                For i = 0 To 14
                Input #1, aenviaraslc(i)
                Next i
                Close #1
    End If
            Else    'else de if grupo=1
                If Dir("Configuracion ascensor 1.dat") = "" Then
                    Open "Configuracion ascensor 1.dat" For Output As #1
                    Write #1, 1             'NÙMERO DE ASCENSOR
                    For i = 1 To 25     'Configuracion..." TIENE 26 BYTES (INFO DEL ASCENSOR + INFO DE
                    Write #1, 0         'LLAMADAS DE GRUPO)
                    Next i
                    Close #1
                    ' CARGA EN aenviaraslc VALORES DEFAULT DEL ASCENSOR 1
                    aenviaraslc(1) = 0
                    aenviaraslc(2) = 0
                    For i = 9 To 12      'ANULADAS CABINA ASCENSOR 1 LADO 1 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    For i = 13 To 16     'ANULADAS CABINA ASCENSOR 1 LADO 2 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    For i = 41 To 48     'ANULADAS SUBIR Y BAJAR GRUPO LADO 1 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    For i = 49 To 56     'ANULADAS SUBIR Y BAJAR GRUPO LADO 2 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                                        
                        Else
                    Open "Configuracion ascensor 1.dat" For Input As #1
                    Input #1, aenviaraslc(0)    'no sirve pero hay que leerlo (es nro de ascensor)
                    Input #1, aenviaraslc(1)    'FUNCIONES ESPECIALES
                    For i = 9 To 12             'ANULADAS x PC CABINA LADO 1 ASC 1
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 13 To 16            'ANULADAS x PC CABINA LADO 2 ASC 1
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 41 To 48            'ANULADAS x PC SUBIR Y BAJAR LADO 1
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 49 To 56            'ANULADAS x PC SUBIR Y BAJAR LADO 2
                    Input #1, aenviaraslc(i)
                    Next i
                    Close #1
                End If
                
                If Dir("Configuracion ascensor 2.dat") = "" Then
                    Open "Configuracion ascensor 2.dat" For Output As #1
                    Write #1, 2         'NÙMERO DE ASCENSOR
                    For i = 1 To 25     'Configuracion..." TIENE 26 BYTES (INFO DEL ASCENSOR + INFO DE
                    Write #1, 0         'LLAMADAS DE GRUPO)
                    Next i
                    Close #1
                    ' CARGA EN aenviaraslc VALORES DEFAULT DEL ASCENSOR 2
                    aenviaraslc(3) = 0
                    aenviaraslc(4) = 0
                    For i = 17 To 20     'ANULADAS CABINA ASCENSOR 2 LADO 1 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    For i = 21 To 24     'ANULADAS CABINA ASCENSOR 2 LADO 2 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    'ANULADAS SUBIR Y BAJAR YA LAS CARGO CUANDO ARMO EL 1
                                        
                        Else
                    Open "Configuracion ascensor 2.dat" For Input As #1
                    Input #1, aenviaraslc(0)    'no sirve pero hay que leerlo (es nro de ascensor)
                    Input #1, aenviaraslc(3)    'FUNCIONES ESPECIALES
                    For i = 17 To 20            'ANULADAS x PC CABINA LADO 1 ASC 2
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 21 To 24            'ANULADAS x PC CABINA LADO 2 ASC 2
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 41 To 48            'ANULADAS x PC SUBIR Y BAJAR LADO 1
                    Input #1, p
                    aenviaraslc(i) = aenviaraslc(i) Or p    'junta las llamadas exteriores anuladas
                    Next i                                  'en ambos archivos de configuracion
                    For i = 49 To 56            'ANULADAS x PC SUBIR Y BAJAR LADO 2
                    Input #1, p
                    aenviaraslc(i) = aenviaraslc(i) Or p    'junta las llamadas exteriores anuladas
                    Next i                                  'en ambos archivos de configuracion
                    Close #1
                End If

                If Dir("Configuracion ascensor 3.dat") = "" Then
                    Open "Configuracion ascensor 3.dat" For Output As #1
                    Write #1, 3         'NÙMERO DE ASCENSOR
                    For i = 1 To 25     'Configuracion..." TIENE 26 BYTES (INFO DEL ASCENSOR + INFO DE
                    Write #1, 0         'LLAMADAS DE GRUPO)
                    Next i
                    Close #1
                    ' CARGA EN aenviaraslc VALORES DEFAULT DEL ASCENSOR 3
                    aenviaraslc(5) = 0
                    aenviaraslc(6) = 0
                    For i = 25 To 28     'ANULADAS CABINA ASCENSOR 3 LADO 1 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    For i = 29 To 32     'ANULADAS CABINA ASCENSOR 3 LADO 2 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    'ANULADAS SUBIR Y BAJAR YA LAS CARGO CUANDO ARMO EL 1 O EL 2
                                        
                        Else
                    Open "Configuracion ascensor 3.dat" For Input As #1
                    Input #1, aenviaraslc(0)    'no sirve pero hay que leerlo (es nro de ascensor)
                    Input #1, aenviaraslc(5)    'FUNCIONES ESPECIALES
                    For i = 25 To 28            'ANULADAS x PC CABINA LADO 1 ASC 3
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 29 To 32            'ANULADAS x PC CABINA LADO 2 ASC 3
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 41 To 48            'ANULADAS x PC SUBIR Y BAJAR LADO 1
                    Input #1, p
                    aenviaraslc(i) = aenviaraslc(i) Or p    'junta las llamadas exteriores anuladas
                    Next i                                  'en ambos archivos de configuracion
                    For i = 49 To 56            'ANULADAS x PC SUBIR Y BAJAR LADO 2
                    Input #1, p
                    aenviaraslc(i) = aenviaraslc(i) Or p    'junta las llamadas exteriores anuladas
                    Next i                                  'en ambos archivos de configuracion
                    Close #1
                End If

                If Dir("Configuracion ascensor 4.dat") = "" Then
                    Open "Configuracion ascensor 4.dat" For Output As #1
                    Write #1, 4         'NÙMERO DE ASCENSOR
                    For i = 1 To 25     'Configuracion..." TIENE 26 BYTES (INFO DEL ASCENSOR + INFO DE
                    Write #1, 0         'LLAMADAS DE GRUPO)
                    Next i
                    Close #1
                    ' CARGA EN aenviaraslc VALORES DEFAULT DEL ASCENSOR 3
                    aenviaraslc(7) = 0
                    aenviaraslc(8) = 0
                    For i = 33 To 36     'ANULADAS CABINA ASCENSOR 4 LADO 1 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    For i = 37 To 40     'ANULADAS CABINA ASCENSOR 4 LADO 2 (ARCHIVO NO EXISTE -> SON TODAS 0 POR DEFAULT)
                    aenviaraslc(i) = 0
                    Next i
                    'ANULADAS SUBIR Y BAJAR YA LAS CARGO CUANDO ARMO EL 1 O EL 2 O EL 3
                                        
                        Else
                    Open "Configuracion ascensor 4.dat" For Input As #1
                    Input #1, aenviaraslc(0)    'no sirve pero hay que leerlo (es nro de ascensor)
                    Input #1, aenviaraslc(7)    'FUNCIONES ESPECIALES
                    For i = 33 To 36            'ANULADAS x PC CABINA LADO 1 ASC 4
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 37 To 40            'ANULADAS x PC CABINA LADO 2 ASC 4
                    Input #1, aenviaraslc(i)
                    Next i
                    For i = 41 To 48            'ANULADAS x PC SUBIR Y BAJAR LADO 1
                    Input #1, p
                    aenviaraslc(i) = aenviaraslc(i) Or p    'junta las llamadas exteriores anuladas
                    Next i                                  'en ambos archivos de configuracion
                    For i = 49 To 56            'ANULADAS x PC SUBIR Y BAJAR LADO 2
                    Input #1, p
                    aenviaraslc(i) = aenviaraslc(i) Or p    'junta las llamadas exteriores anuladas
                    Next i                                  'en ambos archivos de configuracion
                    Close #1
                End If

End If

' ABRE ARCHIVO DE REGISTRO DE LLAMADAS
Open "Llamadas.dat" For Append As #5
Open "Eventos.dat" For Append As #6

Exit Sub

errorhandler:
codigoerror = Err.Number
textoerror = Err.Description
MsgBox Err.Description, vbExclamation, "Monitoreo SILCON"
' Si el puerto elegido esta en uso vuelve al seteo anterior
Rem MSComm1.CommPort = i
Rem MSComm1.Settings = "38400,n,8,2"
Rem MSComm1.PortOpen = True

Rem Resume Next
If codigoerror = 8002 Then
                Frame5.Visible = True
End If


End Sub

'**********************************************************************************

Private Sub Command18_Click()
' ABRE MENU "Configuracion Sistema"
' Carga el puerto COM guardado
Open "Configuracion sistema.dat" For Input As #7
Input #7, setcom
For i = 0 To 9
If i = setcom - 1 Then
                        Option1(i).Value = True
                      Else
                        Option1(i).Value = False
End If
Next i

'Carga la cantidad de paradas guardada
Input #7, k
Combo1.Text = Str$(k)

'Carga la cantidad de ascensores guardada
Input #7, k
If k = 1 Then
           Option2(0).Value = True
         Else
            If k = 2 Then
                        Option2(1) = True
                     Else: Option2(2) = True
            End If
End If
Close #7

Frame5.Visible = True

End Sub

'**********************************************************************************

Private Sub Command7_Click()
' "Cancelar" en menu "Configuracion Sistema"
Frame5.Visible = False

End Sub

'**********************************************************************************

Private Sub Command8_Click()
' "Aceptar" en menu "Configuracion Sistema"
On Local Error GoTo errordepuerto
j = 0
For i = 0 To 9
If Option1(i).Value = True Then j = i + 1
Next i
If j = 0 Then
        MsgBox "Debe especificar un puerto", vbExclamation, "Monitoreo SILCON"
        Exit Sub
            Else
                i = MSComm1.CommPort
                MSComm1.PortOpen = False
                MSComm1.CommPort = j
                MSComm1.Settings = "38400,n,8,2"
                ' Open the port.
                MSComm1.PortOpen = True
End If

k = Val(Combo1.Text)
paradas = k

If Option2(0).Value = True Then
                            l = 1
                            grupo = 1
                           Else
                            If Option2(1) = True Then
                                                   l = 2
                                                   grupo = 2
                                                 Else
                                                    If Option2(2) = True Then
                                                                        l = 3
                                                                        grupo = 3
                                                                            Else
                                                                            l = 4
                                                                            grupo = 4
                                                    End If
                            End If
End If

' Vuelve a establecer los valores del puerto de acuerdo al seteo

' Cierra el puerto
MSComm1.PortOpen = False

If grupo = 1 Then
                'Si es simplex, recibe 56 bytes y dispara OnComm event
                MSComm1.InBufferSize = 56
                MSComm1.RThreshold = 56

                MSComm1.OutBufferSize = 16
                MSComm1.SThreshold = 0      '16  Si es 0 nunca dispara oncommevent al transmitir
             Else
                'Si es triplex, recibe 470 bytes y dispara OnComm event
                MSComm1.InBufferSize = 470
                MSComm1.RThreshold = 470

                MSComm1.OutBufferSize = 58
                MSComm1.SThreshold = 0      '16  Si es 0 nunca dispara oncommevent al transmitir
End If

' Abre el puerto
MSComm1.PortOpen = True

'Guarda los valores seteados
Open "Configuracion sistema.dat" For Output As #7
Write #7, j, k, l
Close #7

Frame5.Visible = False

Exit Sub

errordepuerto:
MsgBox "El puerto esta en uso", vbExclamation, "Monitoreo SILCON"
' Si el puerto elegido esta en uso vuelve al seteo anterior
MSComm1.CommPort = i
MSComm1.Settings = "38400,n,8,2"
MSComm1.PortOpen = True

End Sub

'**********************************************************************************

'ABRE MENU "Configuracion de Ascensores"
Private Sub Command17_Click()
'Recarga los items seleccionados
If grupo = 1 Then
    j = aenviaraslc(1)      'aenviaraslc ADEMAS DE LO QUE ENVIA TIENE EL ESTADO CONFIGURADO
    For i = 0 To 7          'aenviaraslc(1)= FUNCIONES ESPECIALES
    k = j Mod 2
    If k = 1 Then
                Check1(i).Value = 1
              Else
                Check1(i).Value = 0
    End If
    j = Int(j / 2)
    Next i
             Else
                For p = 0 To 3          'PARA 4 ASCENSORES
                j = aenviaraslc(p * 2 + 1)
                For i = 0 To 7
                k = j Mod 2
                    If k = 1 Then
                        Check1(p * 8 + i).Value = 1
                            Else
                        Check1(p * 8 + i).Value = 0
                End If
                j = Int(j / 2)
                Next i
                Next p
End If

If TabStrip1.SelectedItem.Index = 1 Then
                          'Hace visible el frame del ascensor 1
                          Frame2(0).Visible = True
                          'Oculta el frame del ascensor 2
                          Frame2(1).Visible = False
                          'Oculta el frame del ascensor 3
                          Frame2(2).Visible = False
                          'Oculta el frame del ascensor 4
                          Frame2(3).Visible = False
                          
                                    Else
                                     If TabStrip1.SelectedItem.Index = 2 Then
                                             'Oculta el frame del ascensor 1
                                             Frame2(0).Visible = False
                                             'Hace visible el frame del ascensor 2
                                             Frame2(1).Visible = True
                                             'Oculta el frame del ascensor 3
                                             Frame2(2).Visible = False
                                             'Oculta el frame del ascensor 4
                                             Frame2(3).Visible = False
                                                 Else
                                                    If TabStrip1.SelectedItem.Index = 3 Then
                                                         'Oculta el frame del ascensor 1
                                                         Frame2(0).Visible = False
                                                         'Oculta el frame del ascensor 2
                                                         Frame2(1).Visible = False
                                                         'Hace visible el frame del ascensor 3
                                                         Frame2(2).Visible = True
                                                         'Oculta el frame del ascensor 4
                                                         Frame2(3).Visible = False
                                                            Else
                                                                            'Oculta el frame del ascensor 1
                                                                            Frame2(0).Visible = False
                                                                            'Oculta el frame del ascensor 2
                                                                            Frame2(1).Visible = False
                                                                            'Oculta el frame del ascensor 3
                                                                            Frame2(2).Visible = False
                                                                            'Hace visible el frame del ascensor 4
                                                                            Frame2(3).Visible = True
                                                    End If
                                     End If
End If

'Hace visible el frame de configuracion
Frame1.Visible = True

End Sub

'**********************************************************************************

'"ACEPTAR" EN "Configuracion de Ascensores"
Private Sub Command2_Click()

If grupo = 1 Then
        aenviaraslc(1) = Check1(0).Value + Check1(1).Value * 2 + Check1(2).Value * 4 + Check1(3).Value * 8 + Check1(4).Value * 16 + Check1(5).Value * 32 + Check1(6).Value * 64 + Check1(7).Value * 128
             Else
               aenviaraslc(1) = Check1(0).Value + Check1(1).Value * 2 + Check1(2).Value * 4 + Check1(3).Value * 8 + Check1(4).Value * 16 + Check1(5).Value * 32 + Check1(6).Value * 64 + Check1(7).Value * 128
               aenviaraslc(3) = Check1(8).Value + Check1(9).Value * 2 + Check1(10).Value * 4 + Check1(11).Value * 8 + Check1(12).Value * 16 + Check1(13).Value * 32 + Check1(14).Value * 64 + Check1(15).Value * 128
               aenviaraslc(5) = Check1(16).Value + Check1(17).Value * 2 + Check1(18).Value * 4 + Check1(19).Value * 8 + Check1(20).Value * 16 + Check1(21).Value * 32 + Check1(22).Value * 64 + Check1(23).Value * 128
               aenviaraslc(7) = Check1(24).Value + Check1(25).Value * 2 + Check1(26).Value * 4 + Check1(27).Value * 8 + Check1(28).Value * 16 + Check1(29).Value * 32 + Check1(30).Value * 64 + Check1(31).Value * 128
End If

If grupo = 1 Then
                'Guarda configuracion de un solo ascensor (aenviaraslc es de 15 bytes)
                Kill "Configuracion ascensor 1.dat"
                Open "Configuracion ascensor 1.dat" For Output As #1
                For i = 0 To 14
                Write #1, aenviaraslc(i)
                Next i
                Close #1
             Else
                             'Guarda configuracion de 4 ascensores (aenviaraslc es de 58 bytes)
                             Kill "Configuracion ascensor 1.dat"
                             Open "Configuracion ascensor 1.dat" For Output As #1
                             Write #1, 1                     'nro. de ascensor
                             Write #1, aenviaraslc(1)        'SI, TC, PTT, etc
                             For i = 9 To 12                 'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 13 To 16                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1
                
                             Kill "Configuracion ascensor 2.dat"
                             Open "Configuracion ascensor 2.dat" For Output As #1
                             Write #1, 2                     'nro. de ascensor
                             Write #1, aenviaraslc(3)        'SI, TC, PTT, etc
                             For i = 17 To 20                'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 21 To 24                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1
                             
                             Kill "Configuracion ascensor 3.dat"
                             Open "Configuracion ascensor 3.dat" For Output As #1
                             Write #1, 3                     'nro. de ascensor
                             Write #1, aenviaraslc(5)        'SI, TC, PTT, etc
                             For i = 25 To 28                'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 29 To 32                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1
            
                             Kill "Configuracion ascensor 4.dat"
                             Open "Configuracion ascensor 4.dat" For Output As #1
                             Write #1, 4                     'nro. de ascensor
                             Write #1, aenviaraslc(7)        'SI, TC, PTT, etc
                             For i = 33 To 36                'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 37 To 40                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1

End If

Frame1.Visible = False
    
End Sub

'**********************************************************************************

'"CANCELAR" EN "Configuracion"
Private Sub Command1_Click()
Frame1.Visible = False

End Sub



'**********************************************************************************

Private Sub TabStrip1_Click()
'Arma los datos de acuerdo al tab sobre el que se hizo click

If TabStrip1.SelectedItem.Index = 1 Then
                          'Hace visible el frame del ascensor 1
                          Frame2(0).Visible = True
                          'Oculta el frame del ascensor 2
                          Frame2(1).Visible = False
                          'Oculta el frame del ascensor 3
                          Frame2(2).Visible = False
                          'Oculta el frame del ascensor 4
                          Frame2(3).Visible = False
                          
                                    Else
                                     If TabStrip1.SelectedItem.Index = 2 Then
                                             'Oculta el frame del ascensor 1
                                             Frame2(0).Visible = False
                                             'Hace visible el frame del ascensor 2
                                             Frame2(1).Visible = True
                                             'Oculta el frame del ascensor 3
                                             Frame2(2).Visible = False
                                             'Oculta el frame del ascensor 4
                                             Frame2(3).Visible = False
                                                 Else
                                                    If TabStrip1.SelectedItem.Index = 3 Then
                                                         'Oculta el frame del ascensor 1
                                                         Frame2(0).Visible = False
                                                         'Oculta el frame del ascensor 2
                                                         Frame2(1).Visible = False
                                                         'Hace visible el frame del ascensor 3
                                                         Frame2(2).Visible = True
                                                         'Oculta el frame del ascensor 4
                                                         Frame2(3).Visible = False
                                                            Else
                                                                            'Oculta el frame del ascensor 1
                                                                            Frame2(0).Visible = False
                                                                            'Oculta el frame del ascensor 2
                                                                            Frame2(1).Visible = False
                                                                            'Oculta el frame del ascensor 3
                                                                            Frame2(2).Visible = False
                                                                            'Hace visible el frame del ascensor 4
                                                                            Frame2(3).Visible = True
                                                    End If
                                     End If
End If

End Sub

'**********************************************************************************

'ABRE MENU "ANULACION DE LLAMADAS"
Private Sub Command16_Click()
If grupo = 1 Then
    'Recarga los valores guardados de llamadas de cabina anuladas de un ascensor
    For p = 3 To 6
    j = aenviaraslc(p)
    For i = 0 To 7
    k = j Mod 2
    
    If ((p - 3) * 8 + i) < 28 Then     'solo ve 28 llamadas (0 a 27)
        If k = 1 Then
                Check2((p - 3) * 8 + i).Value = 1
              Else
                Check2((p - 3) * 8 + i).Value = 0
        End If
    End If
    
    j = Int(j / 2)
    Next i
    Next p
            
            Else
            'Recarga los valores guardados de llamadas de cabina anuladas de 4 ascensores
            ' AGREGAR LADO 2
            For p = 9 To 12
            j = aenviaraslc(p)       'Llamadas anuladas cabina ascensor 1 LADO 1
            l = aenviaraslc(p + 8)   'Llamadas anuladas cabina ascensor 2 LADO 1
            n = aenviaraslc(p + 16)  'Llamadas anuladas cabina ascensor 3 LADO 1
            r = aenviaraslc(p + 24)  'Llamadas anuladas cabina ascensor 4 LADO 1
            
            For i = 0 To 7
            k = j Mod 2
            m = l Mod 2
            o = n Mod 2
            s = r Mod 2
            
            ' LLAMADAS ASCENSOR 1
            If ((p - 7) * 8 + i) < 28 Then     'solo ve 28 llamadas (0 a 27)
                If k = 1 Then
                    Check2((p - 7) * 8 + i).Value = 1
                    Else
                    Check2((p - 7) * 8 + i).Value = 0
                End If
            End If
            ' LLAMADAS ASCENSOR 2
            If ((p + 8 - 15) * 8 + i) < 28 Then 'solo ve 28 llamadas (0 a 27)
                If m = 1 Then
                    Check5((p + 8 - 15) * 8 + i).Value = 1
                    Else
                    Check5((p + 8 - 15) * 8 + i).Value = 0
                End If
            End If
            ' LLAMADAS ASCENSOR 3
            If ((p + 16 - 23) * 8 + i) < 28 Then   'solo ve 28 llamadas (0 a 27)
                If o = 1 Then
                    Check6((p + 16 - 23) * 8 + i).Value = 1
                    Else
                    Check6((p + 16 - 23) * 8 + i).Value = 0
                End If
            End If
            ' LLAMADAS ASCENSOR 4
            If ((p + 24 - 31) * 8 + i) < 28 Then   'solo ve 28 llamadas (0 a 27)
                If o = 1 Then
                    Check9((p + 24 - 31) * 8 + i).Value = 1
                    Else
                    Check9((p + 24 - 31) * 8 + i).Value = 0
                End If
            End If
            
            j = Int(j / 2)
            l = Int(l / 2)
            n = Int(n / 2)
            r = Int(r / 2)
            Next i
            Next p
End If

'Recarga los valores guardados de llamadas subir anuladas
If grupo = 1 Then           'Si es uno o dos ascensores cambia la ubicacion
                m = 7       'de las llamadas anuladas en aenviaraslc
             Else
                m = 41
End If

For p = m To m + 3
j = aenviaraslc(p)
For i = 0 To 7
k = j Mod 2
If (((p - m) * 8 + i) < 27) Then      'solo ve 27 llamadas (0 a 26)
If k = 1 Then
                Check3((p - m) * 8 + i).Value = 1
              Else
                Check3((p - m) * 8 + i).Value = 0
End If
End If
j = Int(j / 2)
Next i
Next p

'Recarga los valores guardados de llamadas bajar anuladas
If grupo = 1 Then           'Si es uno o dos ascensores cambia la ubicacion
                m = 11      'de las llamadas anuladas en aenviaraslc
             Else
                m = 45
End If

For p = m To m + 3
j = aenviaraslc(p)
For i = 0 To 7
k = j Mod 2
If (((p - m) * 8 + i) > 0) And (((p - m) * 8 + i) < 28) Then
If k = 1 Then
                Check4((p - m) * 8 + i).Value = 1
              Else
                Check4((p - m) * 8 + i).Value = 0
End If
End If
j = Int(j / 2)
Next i
Next p

Rem Hace visible el frame
Frame4.Visible = True

End Sub

'**********************************************************************************

Private Sub Command9_Click()
'"Anular todas" las llamadas de cabina ascensor 1
For i = 0 To 27
  Check2(i).Value = 1
Next i
End Sub

'**********************************************************************************

Private Sub Command20_Click()
'"Anular todas" las llamadas de cabina ascensor 2
For i = 0 To 27
  Check5(i).Value = 1
Next i
End Sub

'**********************************************************************************

Private Sub Command22_Click()
'"Anular todas" las llamadas de cabina ascensor 3
For i = 0 To 27
  Check6(i).Value = 1
Next i
End Sub

'**********************************************************************************
Private Sub Command25_Click()
'"Anular todas" las llamadas de cabina ascensor 4
For i = 0 To 27
  Check9(i).Value = 1
Next i
End Sub

'**********************************************************************************

Private Sub Command10_Click()
'"Anular todas" las llamadas subir
For i = 0 To 26
  Check3(i).Value = 1
Next i
End Sub

'**********************************************************************************

Private Sub Command11_Click()
'"Anular todas" las llamadas bajar
For i = 1 To 27
  Check4(i).Value = 1
Next i
End Sub

'**********************************************************************************
Private Sub Command12_Click()
'"Habilitar todas" las llamadas de cabina ascensor 1
For i = 0 To 27
  Check2(i).Value = 0
Next i
End Sub

'**********************************************************************************

Private Sub Command21_Click()
'"Habilitar todas" las llamadas de cabina ascensor 2
For i = 0 To 27
  Check5(i).Value = 0
Next i
End Sub

'**********************************************************************************

Private Sub Command23_Click()
'"Habilitar todas" las llamadas de cabina ascensor 3
For i = 0 To 27
  Check6(i).Value = 0
Next i
End Sub

'**********************************************************************************
Private Sub Command26_Click()
'"Habilitar todas" las llamadas de cabina ascensor 4
For i = 0 To 27
  Check9(i).Value = 0
Next i
End Sub

'**********************************************************************************

Private Sub Command13_Click()
'"Habilitar todas" las llamadas subir
For i = 0 To 26
  Check3(i).Value = 0
Next i
End Sub

'**********************************************************************************

Private Sub Command14_Click()
'"Habilitar todas" las llamadas bajar
For i = 1 To 27
  Check4(i).Value = 0
Next i
End Sub

'**********************************************************************************

'"Aceptar" en "Anulacion de llamadas"
Private Sub Command6_Click()
If grupo = 1 Then
    'Forma la mascara de anulacion de llamadas de cabina para un ascensor
    For p = 3 To 6
    aenviaraslc(p) = 0
    For i = 0 To 7
    If ((p - 3) * 8 + i) < 28 Then
      If Check2((p - 3) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
    End If
    Next i
    Next p
        
        Else
            'Forma la mascara de anulacion de llamadas de cabina para el ascensor 1
            For p = 9 To 12
            aenviaraslc(p) = 0
            For i = 0 To 7
            If ((p - 9) * 8 + i) < 28 Then
                If Check2((p - 9) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
            End If
            Next i
            Next p
            'Forma la mascara de anulacion de llamadas de cabina para el ascensor 2
            For p = 17 To 20
            aenviaraslc(p) = 0
            For i = 0 To 7
            If ((p - 17) * 8 + i) < 28 Then
                If Check5((p - 17) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
            End If
            Next i
            Next p
            'Forma la mascara de anulacion de llamadas de cabina para el ascensor 3
            For p = 25 To 28
            aenviaraslc(p) = 0
            For i = 0 To 7
            If ((p - 25) * 8 + i) < 28 Then
                If Check6((p - 25) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
            End If
            Next i
            Next p
            'Forma la mascara de anulacion de llamadas de cabina para el ascensor 4
            For p = 33 To 36
            aenviaraslc(p) = 0
            For i = 0 To 7
            If ((p - 33) * 8 + i) < 28 Then
                If Check9((p - 33) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
            End If
            Next i
            Next p
            

' AGREGAR LADO 2

End If

If grupo = 1 Then
                m = 7
             Else
                m = 41
End If
'Forma la mascara de anulacion de llamadas subir
For p = m To m + 3
aenviaraslc(p) = 0
For i = 0 To 7
If ((p - m) * 8 + i) < 27 Then
   If Check3((p - m) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
End If
Next i
Next p

'Forma la mascara de anulacion de llamadas bajar
If grupo = 1 Then
                m = 11
             Else
                m = 45
End If
For p = m To m + 3
aenviaraslc(p) = 0

For i = 0 To 7
If (((p - m) * 8 + i) > 0) And (((p - m) * 8 + i) < 28) Then
     If Check4((p - m) * 8 + i).Value = 1 Then aenviaraslc(p) = aenviaraslc(p) + 2 ^ i
End If
Next i

Next p

'Guarda Mascaras de anulacion de llamadas
If grupo = 1 Then
                Kill "Configuracion ascensor 1.dat"
                Open "Configuracion ascensor 1.dat" For Output As #1
                For i = 0 To 14
                Write #1, aenviaraslc(i)
                Next i
                Close #1
             Else
                             'Guarda configuracion de 4 ascensores (aenviaraslc es de 58 bytes)
                             Kill "Configuracion ascensor 1.dat"
                             Open "Configuracion ascensor 1.dat" For Output As #1
                             Write #1, 1                     'nro. de ascensor
                             Write #1, aenviaraslc(1)        'SI, TC, PTT, etc
                             For i = 9 To 12                 'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 13 To 16                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1
                
                             Kill "Configuracion ascensor 2.dat"
                             Open "Configuracion ascensor 2.dat" For Output As #1
                             Write #1, 2                     'nro. de ascensor
                             Write #1, aenviaraslc(3)        'SI, TC, PTT, etc
                             For i = 17 To 20                'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 21 To 24                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1
                             
                             Kill "Configuracion ascensor 3.dat"
                             Open "Configuracion ascensor 3.dat" For Output As #1
                             Write #1, 3                     'nro. de ascensor
                             Write #1, aenviaraslc(5)        'SI, TC, PTT, etc
                             For i = 25 To 28                'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 29 To 32                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1
            
                             Kill "Configuracion ascensor 4.dat"
                             Open "Configuracion ascensor 4.dat" For Output As #1
                             Write #1, 4                     'nro. de ascensor
                             Write #1, aenviaraslc(7)        'SI, TC, PTT, etc
                             For i = 33 To 36                'Llamadas anuladas cabina lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 37 To 40                'Llamadas anuladas cabina lado 2
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 41 To 48                'Llamadas anuladas subir y bajar lado 1
                             Write #1, aenviaraslc(i)
                             Next i
                             For i = 49 To 56                'Llamadas anuladas subir y bajar lado 2
                             Write #1, 0
                             Next i
                             Close #1

End If

Frame4.Visible = False

End Sub

'**********************************************************************************

'"CANCELAR" EN "ANULACION DE LLAMADAS"
Private Sub Command5_Click()
Frame4.Visible = False

End Sub

'**********************************************************************************

Private Sub Label20_Click(Index As Integer)
'Arma envio de "Colocar llamada de Cabina" en ascensor 1 o 2 o 3 o 4
If Index > 83 Then
                colocarllamada(1) = 0
                colocarllamada(2) = 0
                colocarllamada(3) = 0
                colocarllamada(4) = Index - 84 + 1 + 64    '64 es "0100 0000", indicando con "01" en bits 7 y 6 que es llamada cabina
             Else
                If Index > 55 Then
                    colocarllamada(1) = 0
                    colocarllamada(2) = 0
                    colocarllamada(3) = Index - 56 + 1 + 64    '64 es "0100 0000", indicando con "01" en bits 7 y 6 que es llamada cabina
                    colocarllamada(4) = 0
                  Else
                    If Index > 27 Then
                        colocarllamada(1) = 0
                        colocarllamada(2) = Index - 28 + 1 + 64    '64 es "0100 0000", indicando con "01" en bits 7 y 6 que es llamada cabina
                        colocarllamada(3) = 0
                        colocarllamada(4) = 0
                       Else
                            colocarllamada(1) = Index + 1 + 64
                            colocarllamada(2) = 0
                            colocarllamada(3) = 0
                            colocarllamada(4) = 0
                    End If
                End If
End If

End Sub

'**********************************************************************************

Private Sub Picture5_Click(Index As Integer)
'Arma envio de "Colocar llamada Subir"

colocarllamada(1) = Index + 1 + 128                    '128 es "1000 0000", indicando con "10" en bits 7 y 6 que es llamada subir
colocarllamada(2) = Index + 1 + 128
colocarllamada(3) = Index + 1 + 128
colocarllamada(4) = Index + 1 + 128

End Sub

'**********************************************************************************

Private Sub Picture4_Click(Index As Integer)
'Arma envio de "Colocar llamada Bajar"

colocarllamada(1) = Index + 1 + 192                    '192 es "1100 0000", indicando con "11" en bits 7 y 6 que es llamada bajar
colocarllamada(2) = Index + 1 + 192
colocarllamada(3) = Index + 1 + 192
colocarllamada(4) = Index + 1 + 192

End Sub

'**********************************************************************************

' "Cancelar" en Password
Private Sub Command3_Click()
Frame3.Visible = False

End Sub

'**********************************************************************************

' "Aceptar" en Password
Private Sub Command4_Click()
If Text4.Text = "silcon" Then
    Frame3.Visible = False
    Else
        Text4.Text = ""
        Text4.SetFocus
End If
End Sub

'**********************************************************************************

' Click en "Alarma de Incendio"
Private Sub COMMAND24_Click()
Frame3.Visible = True
Rem Limpia Text4 (Password) y pone el cursor ahi
Text4.Text = ""
Text4.SetFocus

End Sub

'**********************************************************************************

' Click en "Salir"
Private Sub Command19_Click()
On Local Error Resume Next

' Close the port.
MSComm1.PortOpen = False
Close #5

End
End Sub

'**********************************************************************************

Private Sub MSComm1_OnComm()
'Pinta marcador de espera de RX color negro (porque hubo RX aunque no sabe si el paquete está OK)
Shape1.FillColor = QBColor(0)
'Pinta marcador de RX recibida color rojo
Shape2.FillColor = QBColor(12)
'Pinta marcador de paquete recibido OK color negro (todavía no sabe si el paquete está OK)
'Shape3.FillColor = QBColor(0)

Select Case MSComm1.CommEvent
        
    Case comEvReceive
       If grupo = 1 Then
                    m = 55
                    Else
                    m = 93
       End If
       
       
' CUANDO RECIBE LOS 5 PAQUETES -> VE SI PRIMER BYTE ES $40 (INICIO DE PAQUETE 0)
' SI ES ASÍ -> GUARDA LO RECIBIDO (NO COMPRUEBA SI ESTÁN $41, 42, ... AL INICIO DE LOS OTROS PAQUETES)
       s = MSComm1.Input
       If Asc(s) = 64 Then      '$40
                recibido(0, 0) = j
                paquete0 = 1
                For i = 1 To m
                    s = MSComm1.Input
 '                  Si recibio FF no se puede hacer Asc("")=255
                    If s = "" Then
                                j = 255
                              Else
                                j = Asc(s)
                    End If
                    recibido(0, i) = j
                Next i
                
                s = MSComm1.Input    '$41
                recibido(1, 0) = j
                paquete1 = 1
                For i = 1 To m
                    s = MSComm1.Input
 '                     Si recibio FF no se puede hacer Asc("")=255
                       If s = "" Then
                               j = 255
                           Else
                               j = Asc(s)
                       End If
                       recibido(1, i) = j
                Next i
                
                s = MSComm1.Input    '$42
                recibido(2, 0) = j
                paquete2 = 1
                For i = 1 To m
                    s = MSComm1.Input
 '                     Si recibio FF no se puede hacer Asc("")=255
                       If s = "" Then
                               j = 255
                           Else
                               j = Asc(s)
                       End If
                       recibido(2, i) = j
                Next i
       
                s = MSComm1.Input    '$41
                recibido(3, 0) = j
                paquete3 = 1
                For i = 1 To m
                    s = MSComm1.Input
 '                     Si recibio FF no se puede hacer Asc("")=255
                       If s = "" Then
                               j = 255
                           Else
                               j = Asc(s)
                       End If
                       recibido(3, i) = j
                Next i
       
                s = MSComm1.Input    '$41
                recibido(4, 0) = j
                paquete4 = 1
                For i = 1 To m
                    s = MSComm1.Input
 '                     Si recibio FF no se puede hacer Asc("")=255
                       If s = "" Then
                               j = 255
                           Else
                               j = Asc(s)
                       End If
                       recibido(4, i) = j
                Next i
       End If
       
       If paquete0 = 1 And paquete1 = 1 And paquete2 = 1 And paquete3 = 1 And paquete4 = 1 And recibido(0, 93) = 170 And recibido(1, 93) = 170 And recibido(2, 93) = 170 And recibido(3, 93) = 170 And recibido(4, 93) = 170 Then     'solo analiza cuando recibe todos los paquetes
       paquete0 = 0
       paquete1 = 0
       paquete2 = 0
       paquete3 = 0
       paquete4 = 0
       
'  Arma y envia paquete al SLC
        buffer = ""
        If grupo = 1 Then
                aenviaraslc(2) = colocarllamada(1)
                For i = 0 To 47
                buffer = buffer & Chr$(aenviaraslc(i))
                Next i
                     Else
                       aenviaraslc(2) = colocarllamada(1)
                       aenviaraslc(4) = colocarllamada(2)
                       aenviaraslc(6) = colocarllamada(3)
                       aenviaraslc(8) = colocarllamada(4)
                       buffer = buffer & Chr$(68)           '$44
                       For i = 1 To 56
                       buffer = buffer & Chr$(aenviaraslc(i))
                       Next i
        End If
     
     ' Agrega EOF
        buffer = buffer & Chr$(170)
        
        colocarllamada(1) = 0
        colocarllamada(2) = 0
        colocarllamada(3) = 0
        colocarllamada(4) = 0

        MSComm1.Output = buffer
'        While MSComm1.OutBufferCount > 0
'            Text1.Text = "Enviando"
'        Wend
'        Text1.Text = "Enviado"
    
'******************************************************************************
        'Pinta marcador de espera de RX color negro
        Shape1.FillColor = QBColor(0)
        'Pinta marcador de RX recibida color negro
        'Shape2.FillColor = QBColor(0)
        'Pinta marcador de paquete recibido OK color verde
        Shape3.FillColor = QBColor(2)
    
        Label5.Caption = "Com OK"
        Label5.BackColor = QBColor(2)       'color de fondo = verde
        Label5.ForeColor = QBColor(0)       'color de letras = negro
        OKrecibido = 1
        SinCom = 0
           
'******************************************************************************
'    Guarda llamadas exteriores lado 1 y 2 recibidas
        If grupo = 1 Then
            For i = 4 To 11
            llamexteriores1(i - 4) = recibido(0, i)
            Next i
           Else
            For i = 4 To 11
            llamexteriores1(i - 4) = recibido(0, i)
            llamexteriores2(i - 4) = recibido(0, i + 8)
            Next i
        End If

'******************************************************************************
'    Guarda llamadas exteriores con falla lado 1 y 2
        If grupo = 1 Then
            For i = 20 To 27
            fallaexteriores1(i - 20) = recibido(0, i)
            Next i
           Else
            For i = 20 To 27
            fallaexteriores1(i - 20) = recibido(0, i)
            fallaexteriores2(i - 20) = recibido(0, i + 8)
            Next i
        End If
        

'******************************************************************************

'    Guarda en status(0 a 81) cada byte recibido
'    Si es 1 solo ascensor -> ordena como la info que viene de DPC
        If grupo = 1 Then
            For i = 0 To 4
            status(1, i) = recibido(0, i)
            Next i
            status(1, 5) = recibido(0, 50)
            status(1, 6) = recibido(0, 51)
            status(1, 7) = recibido(0, 53)
            status(1, 8) = recibido(0, 54)
            For i = 11 To 38
            status(1, i) = recibido(0, i - 11)
            Next i
            
                Else
                    For j = 1 To 4   'grupo
                    For i = 1 To 81
                    status(j, i) = recibido(j, i) 'desde 1 porque está el byte de inicio $41, $42, ...
                    Next i
                    Next j
        End If
        
'******************************************************************************
'    Guarda llamada que está yendo a atender cada ascensor
        If grupo = 1 Then
                accionL1(1) = recibido(0, 51)
            Else
            accionL1(1) = status(1, 24)
            accionL1(2) = status(2, 24)
            accionL1(3) = status(3, 24)
            accionL1(4) = status(4, 24)
            accionL2(1) = status(1, 25)
            accionL2(2) = status(2, 25)
            accionL2(3) = status(3, 25)
            accionL2(4) = status(4, 25)
        End If
        
'******************************************************************************
'    Ve si vino informacion nueva
        p = 0
        For j = 1 To 4
        For i = 1 To 81
            If status(j, i) <> previewstatus(j, i) Then
                                            p = 255
            End If
        Next i
        Next j
        
        For i = 0 To 7
            If llamexteriores1(i) <> previewllamadas1(i) Then
                                            p = 255
            End If
        Next i
        
        For i = 0 To 7
            If fallaexteriores1(i) <> previewfalladas1(i) Then
                                            p = 255
            End If
        Next i
        
        If previeweventoDPC <> recibido(0, 68) Then
                                            p = 255
        End If

        If p = 255 Then
                
'******************************************************************************
'     ARMA LOS RECTÁNGULOS DE FONDO DE PASADIZO DE CADA ASCENSOR, DE ACUERDO A
'     PARADA SUPERIOR Y PARADA INFERIOR
'     TOP ES LA PARTE SUPERIOR DEL RECTANGULO. ABAJO INICIA EN 7680
'     CADA PARADA TIENE h=240
        If grupo = 1 Then
            Picture7(0).BackColor = QBColor(0)      'si es simplex -> todo el fondo del pasadizo color negro
            Picture7(1).BackColor = QBColor(0)      '(el SLC no manda parada inferior/superior. Solo los manda
            Picture7(2).BackColor = QBColor(0)      'el DPC)
            
                    Else
                       ' PUNTO 0,0 ESTÁ ARRIBA A LA IZQUIERDA
                       ' 7680 ES LA BASE DEL PASADIZO
                       ' CADA PISO TIENE 240 DE ALTO
                            If (status(1, 3) <> 0) And (status(1, 4) <> 0) Then
                                                Picture7(0).Width = 900
                                                Picture7(0).Left = 3120
                                                Picture7(0).Top = 7680 - (status(1, 3) - 1) * 240  'status(1,2) es paradainferior
                                                Picture7(0).Height = (status(1, 3) - 1) * 240
                                                Picture7(1).Width = 900
                                                Picture7(1).Left = 3120
                                                Picture7(1).Top = 7680 - status(1, 4) * 240        'status(1,2) es paradasuperior
                                                Picture7(1).Height = (status(1, 4) - status(1, 3) + 1) * 240
                                                Picture7(2).Width = 900
                                                Picture7(2).Left = 3120
                                                Picture7(2).Top = 7680 - 28 * 240       '28 es la cantidad de paradas máximas dibujada en pantalla
                                                Picture7(2).Height = (28 - status(1, 4)) * 240
                                                    Else
                                                        Picture7(0).BackColor = QBColor(0)     'si paradainferior o paradasuperior son 0
                                                        Picture7(1).BackColor = QBColor(0)     '-> pinta todo el pasadizo de negro
                                                        Picture7(2).BackColor = QBColor(0)
                            End If
                            If (status(2, 3) <> 0) And (status(2, 4) <> 0) Then
                                                Picture10(0).Width = 900
                                                Picture10(0).Left = 5520
                                                Picture10(0).Top = 7680 - (status(2, 3) - 1) * 240
                                                Picture10(0).Height = (status(2, 3) - 1) * 240
                                                Picture10(1).Width = 900
                                                Picture10(1).Left = 5520
                                                Picture10(1).Top = 7680 - status(2, 4) * 240
                                                Picture10(1).Height = (status(2, 4) - status(2, 3) + 1) * 240
                                                Picture10(2).Width = 900
                                                Picture10(2).Left = 5520
                                                Picture10(2).Top = 7680 - 28 * 240       '28 es la cantidad de paradas máximas dibujada en pantalla
                                                Picture10(2).Height = (28 - status(2, 4)) * 240
                                                    Else
                                                        Picture10(0).BackColor = QBColor(0)     'si paradainferior o paradasuperior son 0
                                                        Picture10(1).BackColor = QBColor(0)     '-> pinta todo el pasadizo de negro
                                                        Picture10(2).BackColor = QBColor(0)
                            End If
                            If (status(3, 3) <> 0) And (status(3, 4) <> 0) Then
                                                Picture11(0).Width = 900
                                                Picture11(0).Left = 7920
                                                Picture11(0).Top = 7680 - (status(3, 3) - 1) * 240
                                                Picture11(0).Height = (status(3, 3) - 1) * 240
                                                Picture11(1).Width = 900
                                                Picture11(1).Left = 7920
                                                Picture11(1).Top = 7680 - status(3, 4) * 240
                                                Picture11(1).Height = (status(3, 4) - status(3, 3) + 1) * 240
                                                Picture11(2).Width = 900
                                                Picture11(2).Left = 7920
                                                Picture11(2).Top = 7680 - 28 * 240       '28 es la cantidad de paradas máximas dibujada en pantalla
                                                Picture11(2).Height = (28 - status(3, 4)) * 240
                                                    Else
                                                        Picture11(0).BackColor = QBColor(0)     'si paradainferior o paradasuperior son 0
                                                        Picture11(1).BackColor = QBColor(0)     '-> pinta todo el pasadizo de negro
                                                        Picture11(2).BackColor = QBColor(0)
                            End If
                            If (status(4, 3) <> 0) And (status(4, 4) <> 0) Then
                                                Picture20(0).Width = 900
                                                Picture20(0).Left = 10320
                                                Picture20(0).Top = 7680 - (status(4, 3) - 1) * 240
                                                Picture20(0).Height = (status(4, 3) - 1) * 240
                                                Picture20(1).Width = 900
                                                Picture20(1).Left = 10320
                                                Picture20(1).Top = 7680 - status(4, 4) * 240
                                                Picture20(1).Height = (status(4, 4) - status(4, 3) + 1) * 240
                                                Picture20(2).Width = 900
                                                Picture20(2).Left = 10320
                                                Picture20(2).Top = 7680 - 28 * 240       '28 es la cantidad de paradas máximas dibujada en pantalla
                                                Picture20(2).Height = (28 - status(4, 4)) * 240
                                                    Else
                                                        Picture20(0).BackColor = QBColor(0)     'si paradainferior o paradasuperior son 0
                                                        Picture20(1).BackColor = QBColor(0)     '-> pinta todo el pasadizo de negro
                                                        Picture20(2).BackColor = QBColor(0)
                            End If
            End If

'******************************************************************************
'     Ubica cabinas en la pantalla
'     Si no está conectado (posicion=255), cabina no aparece
'     Si está recuperando (posicion=0), se ve cabina abajo
        For j = 1 To 4
        If status(j, 1) = 255 Then
                        Picture1(j - 1).Visible = False
                        Picture17(j - 1).Visible = False
                        Else
                        Picture1(j - 1).Visible = True
                        Picture17(j - 1).Visible = True
                            If status(j, 1) = 0 Then
                        ' MUESTRA CABINA EN EXTREMO INFERIOR (EXTREMO VIENE EN BYTE 3)
                        Picture1(j - 1).Top = 7560 - ((status(j, 3) - 1) * 240)
                        Picture17(j - 1).Top = 7440 - ((status(j, 3) - 1) * 240)
                            Else
                                If (status(j, 1)) < 29 Then
                                ' MUESTRA CABINA EN SU POSICIÓN (POSICION VIENE EN BYTE 1)
                                Picture1(j - 1).Top = 7560 - ((status(j, 1) - 1) * 240)
                                Picture17(j - 1).Top = 7440 - ((status(j, 1) - 1) * 240)
                                End If
                            End If
        End If
        Next j
        
'******************************************************************************
'     Estado de puertas lado 1
      For j = 1 To grupo
    '----------------
      If status(j, 1) = 0 Then          'posicion=0?
       'Muestra cabina de ascensor perdido (cabina perdido= toda roja)
       Picture1(j - 1).Picture = LoadPicture("cabina perdido.bmp")
          Else                          'sigue por acá si está recuperado
          '----------------
           If (Int(status(j, 14) / 4) Mod 2) = 1 Then       'falló apertura?
            'Muestra cabina con falla de apertura
            Picture1(j - 1).Picture = LoadPicture("cabina abriendo y falla.bmp")
                Else                         'sigue por acá si no falló apertura
                '----------------
                    If (Int(status(j, 14) / 128) Mod 2) = 0 Then      'puertas abiertas?
                      '----------------
                        If (Int(status(j, 11) / 16) Mod 2) = 1 Then
                            'Muestra cabina estacionando (cabina cerrado toda violeta)
                            Picture1(j - 1).Picture = LoadPicture("Cabina estacionando.bmp")
                            Else
                              '----------------
                                If (Int(status(j, 11) / 8) Mod 2) = 0 Then                 'estacionado?
                                    'Muestra cabina con puertas cerradas (cabina cerrado= toda azul)
                                    Picture1(j - 1).Picture = LoadPicture("cabina cerrado.bmp")
                                    Else
                                        'Muestra cabina estacionada ("cabina estacionada"= cabina verde)
                                        Picture1(j - 1).Picture = LoadPicture("cabina estacionada.bmp")
                                End If
                             '----------------
                        End If
                      '----------------
                            Else        'sigue por acá si las seguridades están abiertas
                              '----------------
                                If (Int(status(j, 15) / 1) Mod 2 = 1) Then    'está abriendo?
                                  '----------------
                                    If (Int(status(j, 18) / 2) Mod 2 = 1) Then    'hay reopen?
                                        ' Muestra cabina con puertas abriendo con reopen
                                        Picture1(j - 1).Picture = LoadPicture("Cabina abriendo y reopen.bmp")
                                            Else      'está abriendo y no hay reopen
                                            ' Muestra cabina con puertas abriendo
                                            Picture1(j - 1).Picture = LoadPicture("cabina abriendo.bmp")
                                    End If
                                  '----------------
                                        Else        'sigue por acá si no está abriendo
                                          '----------------
                                            If (Int(status(j, 15) / 2) Mod 2 = 1) Then    'está cerrando?
                                              '----------------
                                                If (Int(status(j, 18) / 2) Mod 2 = 1) Then    'hay reopen?
                                                ' Muestra cabina con puertas cerrando con reopen
                                                Picture1(j - 1).Picture = LoadPicture("Cabina cerrando y reopen.bmp")
                                                    Else      'está cerrando y no hay reopen
                                                        ' Muestra cabina con puertas cerrando
                                                        Picture1(j - 1).Picture = LoadPicture("cabina cerrando.bmp")
                                                End If
                                              '----------------
                                                Else       'sigue por acá si no está abriendo ni cerrando
                                                  '----------------
                                                    If (Int(status(j, 18) / 2) Mod 2 = 1) Then    '
                                                    ' Muestra cabina con puertas abiertas con reopen
                                                    Picture1(j - 1).Picture = LoadPicture("Cabina abierta y reopen.bmp")
                                                        Else
                                                        ' Muestra cabina con puertas abiertas (cabina abierta= toda amarilla)
                                                        Picture1(j - 1).Picture = LoadPicture("cabina abierta.bmp")
                                                    End If
                                                 '----------------
                                            End If
                                        '----------------
                                End If
                            '----------------
                    End If
                '----------------
           End If
        '----------------
      End If
    '----------------
     Next j
        

'     Estado de puertas lado 2
      For j = 1 To grupo
    '----------------
      If status(j, 1) = 0 Then          'posicion=0?
       'Muestra cabina de ascensor perdido (cabina perdido= toda roja)
       Picture17(j - 1).Picture = LoadPicture("cabina perdido.bmp")
          Else                          'sigue por acá si está recuperado
          '----------------
           If (Int(status(j, 14) / 8) Mod 2) = 1 Then       'falló apertura?
            'Muestra cabina con falla de apertura
            Picture17(j - 1).Picture = LoadPicture("cabina abriendo y falla.bmp")
                Else                         'sigue por acá si no falló apertura
                '----------------
                    If (Int(status(j, 14) / 128) Mod 2) = 0 Then      'puertas abiertas?
                      '----------------
                        If (Int(status(j, 11) / 16) Mod 2) = 1 Then
                            'Muestra cabina estacionando (cabina cerrado toda violeta)
                            Picture17(j - 1).Picture = LoadPicture("Cabina estacionando.bmp")
                            Else
                              '----------------
                                If (Int(status(j, 11) / 8) Mod 2) = 0 Then                 'estacionado?
                                    'Muestra cabina con puertas cerradas (cabina cerrado= toda azul)
                                    Picture17(j - 1).Picture = LoadPicture("cabina cerrado.bmp")
                                    Else
                                        'Muestra cabina estacionada ("cabina estacionada"= cabina verde)
                                        Picture17(j - 1).Picture = LoadPicture("cabina estacionada.bmp")
                                End If
                             '----------------
                        End If
                      '----------------
                            Else        'sigue por acá si las seguridades están abiertas
                              '----------------
                                If (Int(status(j, 15) / 4) Mod 2 = 1) Then    'está abriendo?
                                  '----------------
                                    If (Int(status(j, 18) / 8) Mod 2 = 1) Then    'hay reopen?
                                        ' Muestra cabina con puertas abriendo con reopen
                                        Picture17(j - 1).Picture = LoadPicture("Cabina abriendo y reopen.bmp")
                                            Else      'está abriendo y no hay reopen
                                            ' Muestra cabina con puertas abriendo
                                            Picture17(j - 1).Picture = LoadPicture("cabina abriendo.bmp")
                                    End If
                                  '----------------
                                        Else        'sigue por acá si no está abriendo
                                          '----------------
                                            If (Int(status(j, 15) / 8) Mod 2 = 1) Then    'está cerrando?
                                              '----------------
                                                If (Int(status(j, 18) / 8) Mod 2 = 1) Then    'hay reopen?
                                                ' Muestra cabina con puertas cerrando con reopen
                                                Picture17(j - 1).Picture = LoadPicture("Cabina cerrando y reopen.bmp")
                                                    Else      'está cerrando y no hay reopen
                                                        ' Muestra cabina con puertas cerrando
                                                        Picture17(j - 1).Picture = LoadPicture("cabina cerrando.bmp")
                                                End If
                                              '----------------
                                                Else       'sigue por acá si no está abriendo ni cerrando
                                                  '----------------
                                                    If (Int(status(j, 18) / 8) Mod 2 = 1) Then    'Reopen abierto?
                                                    ' Muestra cabina con puertas abiertas con reopen
                                                    Picture17(j - 1).Picture = LoadPicture("Cabina abierta y reopen.bmp")
                                                        Else
                                                        ' Muestra cabina con puertas abiertas (cabina abierta= toda amarilla)
                                                        Picture17(j - 1).Picture = LoadPicture("cabina abierta.bmp")
                                                    End If
                                                 '----------------
                                            End If
                                        '----------------
                                End If
                            '----------------
                    End If
                '----------------
           End If
        '----------------
      End If
    '----------------
     Next j


'******************************************************************************
'     Muestra configuración del ascensor en Label10
        For j = 1 To 4
          Label10(j - 1).BackColor = QBColor(11)        'color de fondo= cyan
          Label10(j - 1).ForeColor = QBColor(0)         'color de letras= negro
             If status(j, 1) = 255 Then           'posicion=255? (no está conectado)
                                    Label10(j - 1).Caption = "---------"
                                Else
                                    'ARMA TEXTO DE MANIOBRA Y PARADAS
                                    If (status(j, 20) Mod 4) = 0 Then  'bits 0 y 1=0?
                                       Label10(j - 1).Caption = "Simple" & Str$((status(j, 2))) & "P"
                                       Else
                                       If (status(j, 20) Mod 4) = 1 Then  'bit 0=1 y bit 1=0?
                                         Label10(j - 1).Caption = "Desc" & Str$((status(j, 2))) & "P"
                                         Else
                                         If (status(j, 20) Mod 4) = 2 Then  'bit 0=0 y bit 1=1?
                                           Label10(j - 1).Caption = "FP" & Str$((status(j, 2))) & "P"
                                           Else
                                           Label10(j - 1).Caption = "Full" & Str$((status(j, 2))) & "P"
                                         End If
                                       End If
                                    End If

                                    'ARMA TEXTO DE TIPO DE ACCIONAMIENTO
                                    If (Int(status(j, 19) / 16) = 0) Then
                                          Label10(j - 1).Caption = Label10(j - 1).Caption & " R1V"
                                    End If
                                    If (Int(status(j, 19) / 16) = 1) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " RHD"
                                    End If
                                    If (Int(status(j, 19) / 16) = 2) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " 1V"
                                    End If
                                    If (Int(status(j, 19) / 16) = 3) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " 1V"
                                    End If
                                    If (Int(status(j, 19) / 16) = 4) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " 2V"
                                    End If
                                    If (Int(status(j, 19) / 16) = 5) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " HD"
                                    End If
                                    If (Int(status(j, 19) / 16) = 6) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " V3F"
                                    End If
                                    If (Int(status(j, 19) / 16) = 7) Then
                                              Label10(j - 1).Caption = Label10(j - 1).Caption & " V3F"
                                    End If

                                    
                                    'ARMA TEXTO DE TIPO DE PUERTAS
                                    k = (((status(j, 19) Mod 128) Mod 64) Mod 32) Mod 16
                                    If (Int(k / 8) = 1) Then   'bit 3=1?
                                           Label10(j - 1).Caption = Label10(j - 1).Caption & " A"  'puerta exterior lado 2 auto
                                                    Else
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " M"  'puerta exterior lado 2 manual
                                    End If
                                    
                                    k = k Mod 8
                                    
                                    If (Int(k / 4) = 1) Then   'bit 2=1?
                                           Label10(j - 1).Caption = Label10(j - 1).Caption & "A"  'puerta cabina lado 2 auto
                                                    Else
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & "M"  'puerta cabina lado 2 manual
                                    End If
                                                
                                    k = k Mod 4
                                    If (Int(k / 2) = 1) Then   'bit 1=1?
                                           Label10(j - 1).Caption = Label10(j - 1).Caption & "A"  'puerta exterior lado 1 auto
                                                    Else
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & "M"  'puerta exterior lado 1 manual
                                    End If
                                    k = k Mod 2
                                    If k = 1 Then   'bit 0=1?
                                           Label10(j - 1).Caption = Label10(j - 1).Caption & "A"  'puerta cabina lado 1 auto
                                                    Else
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & "M"  'puerta cabina lado 2 manual
                                    End If
                                    
                                    'ARMA TEXTO DE TIPO DE GRUPO
                                    If status(j, 22) = 0 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " Sx"  'simplex
                                    End If
                                    If status(j, 22) = 1 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " In"  'interconectado
                                    End If
                                    If status(j, 22) = 2 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " LDPC" 'llamadas a DPC
                                    End If
                                    If status(j, 22) = 3 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " Dx1"  'duplex asc 1
                                    End If
                                    If status(j, 22) = 4 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " Dx2"  'duplex asc 2
                                    End If
                                    If status(j, 22) = 5 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " Tx1"  'triplex asc 1
                                    End If
                                    If status(j, 22) = 6 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " Tx2"  'triplex asc 2
                                    End If
                                    If status(j, 22) = 7 Then
                                                     Label10(j - 1).Caption = Label10(j - 1).Caption & " Tx3"  'triplex asc 3
                                    End If
        End If
     Next j

'******************************************************************************
'     Muestra velocidad de viaje
    For j = 1 To 4
    
    k = status(j, 21)
    bit7 = Int(k / 128)
    k = k Mod 128
    bit6 = Int(k / 64)
    k = k Mod 64
    bit5 = Int(k / 32)
    k = k Mod 32
    bit4 = Int(k / 16)
    k = k Mod 16
    bit3 = Int(k / 8)
    k = k Mod 8
    bit2 = Int(k / 4)
    k = k Mod 4
    bit1 = Int(k / 2)
    k = k Mod 2
    bit0 = k
    
    If bit2 = 1 Then
            'ASCENSOR EN V2 -> PONE EN ROJO LAS 3 LABELS
            Label28(j - 1).BackColor = QBColor(12)
            Label29(j - 1).BackColor = QBColor(12)
            Label30(j - 1).BackColor = QBColor(12)
          Else       'sigue por acá si bit 2= 0
            If 5 = 1 Then
                 'ASCENSOR EN V1 -> PONE EN ROJO LABELS DE LENTA Y V1 Y EN NEGRO LA DE V2
                 Label28(j - 1).BackColor = QBColor(12)
                 Label29(j - 1).BackColor = QBColor(12)
                 Label30(j - 1).BackColor = QBColor(0)
                Else
                  If bit3 = 1 Then
                        'ASCENSOR EN LENTA -> PONE EN ROJO LABEL DE LENTA Y EN NEGRO LABELS DE V1 Y V2
                        Label28(j - 1).BackColor = QBColor(12)
                        Label29(j - 1).BackColor = QBColor(0)
                        Label30(j - 1).BackColor = QBColor(0)
                      Else
                          'ASCENSOR PARADO -> PONE EN NEGRO TODAS LAS LABELS
                          Label28(j - 1).BackColor = QBColor(0)
                          Label29(j - 1).BackColor = QBColor(0)
                          Label30(j - 1).BackColor = QBColor(0)
                  End If
            End If
    End If
    Next j

'******************************************************************************
'     Estado de direccion de viaje
        For j = 1 To 4
             If status(j, 12) Mod 2 = 1 Then    'diractual= bajar?
                Picture2(j - 1).Picture = LoadPicture("bajando.bmp")
                Else
                If (Int(status(j, 12) / 2) Mod 2 = 1) Then    'diractual= subir?
                    Picture2(j - 1).Picture = LoadPicture("subiendo.bmp")
                    Else
                    Picture2(j - 1).Picture = LoadPicture("sin direccion.bmp")
                End If
        End If
        Next j
                
'******************************************************************************
'     Estado de proxima direccion de viaje
        For j = 1 To 4
             If (Int(status(j, 12) / 4) Mod 2 = 1) Then    'proxima direccion= bajar?
                Picture3(j - 1).Picture = LoadPicture("proxima bajar.bmp")
                Else
                If (Int(status(j, 12) / 8) Mod 2 = 1) Then    'proxima direccion= subir?
                    Picture3(j - 1).Picture = LoadPicture("proxima subir.bmp")
                    Else
                    Picture3(j - 1).Picture = LoadPicture("proxima sin direccion.bmp")
                End If
        End If
        Next j
                
'******************************************************************************
'     Estado de seguridades primarias
'        For j = 1 To (grupo)
'        If (Int(status(j, 2) / 8) Mod 2 = 1) Then
'                Picture6(j - 1).Picture = LoadPicture("emergencia.bmp")
'        End If
'        Next j
        
'******************************************************************************
'     Estado de Automatico/Manual/Fuera de grupo/Fuera de servicio
        For j = 1 To 4
      '-------------
        If status(j, 1) = 255 Then
              Picture6(j - 1).Picture = LoadPicture("Fuera de Grupo.bmp")
              Picture1(j - 1).Picture = LoadPicture("Cabina negra.bmp")
            Else
             '-------------
               If (status(j, 17) Mod 2 = 1) Or (Int(status(j, 17) / 2) Mod 2 = 1) Then  'fuera de servicio temporal?
                    Picture6(j - 1).Picture = LoadPicture("Fuera de servicio temporal.bmp")
                        Else
                        '-------------
                         If (Int(status(j, 17) / 4) Mod 2 = 1) Or (Int(status(j, 17) / 8) Mod 2 = 1) Then 'fuera de servicio permanente?
                            Picture6(j - 1).Picture = LoadPicture("Fuera de servicio permanente.bmp")
                                Else
                                  '-------------
                                   If (Int(status(j, 11) / 2) Mod 2 = 0) Then
                                     Picture6(j - 1).Picture = LoadPicture("manual.bmp")
                                      '-------------
                                        If t_manual_act(j) = 0 Then
                                            t_manual_act(j) = Int(Timer)
                                        End If
                                      '-------------
                                        Else
                                            Picture6(j - 1).Picture = LoadPicture("automatico.bmp")
                                   End If
                                 '-------------
                         End If
                        '-------------
               End If
            '-------------
        End If
      '-------------
        Next j
        
'******************************************************************************
'     Muestra Pesador 80%
        For j = 1 To 4
        If Int(status(j, 18) / 16) Mod 2 = 0 Then
                                    Label18(j - 1).BackColor = QBColor(9)
                                    
                                  Else
                                    Label18(j - 1).BackColor = QBColor(12)
        End If
        Next j

'******************************************************************************
'     Muestra Pesador 100%
        For j = 1 To 4
        If (Int(status(j, 18) / 32) Mod 2 = 0) Then
                                    Label19(j - 1).BackColor = QBColor(9)
                                    
                                  Else
                                    Label19(j - 1).BackColor = QBColor(12)
        End If
        Next j
        
'******************************************************************************
'     Estado de Servicio Independiente
        For j = 1 To 4
        If (Int(status(j, 13) / 8) Mod 2 = 0) Then
                                               Label15(j - 1).BackColor = QBColor(9)
                                               
                                             Else
                                               Label15(j - 1).BackColor = QBColor(12)
                                               
       End If
       Next j
       
'******************************************************************************
'     Estado de Ascensorista
       For j = 1 To 4
       If (Int(status(j, 13) / 4) Mod 2 = 0) Then
                                               Label14(j - 1).BackColor = QBColor(9)
                                             Else
                                               Label14(j - 1).BackColor = QBColor(12)
       End If
       Next j
                
'******************************************************************************
'     Estado de PTT
        For j = 1 To 4
        If status(j, 13) Mod 2 = 0 Then
                                                Label16(j - 1).BackColor = QBColor(9)
                                              Else
                                                Label16(j - 1).BackColor = QBColor(12)
        End If
        Next j

'******************************************************************************
'     Estado de Door Disable
        For j = 1 To 4
        If (Int(status(j, 13) / 2) Mod 2 = 0) Then
                                                Label17(j - 1).BackColor = QBColor(9)
                                              Else
                                                Label17(j - 1).BackColor = QBColor(12)
        End If
        Next j

'******************************************************************************
 '    Muestra caso analizado y reparto
    '----------------
    If grupo = 1 Then
        Label9(0).Caption = "Simplex"
        Label9(1).Caption = "      "        'MUESTRA "     " EN REPARTO DE LLAMADAS
        
     Else
      '----------------
      If recibido(0, 1) >= 192 Then               'vino caso > 500 y reparto
            Label9(0).Caption = "Caso " & Str$((recibido(0, 1) - 192) * 256 + recibido(0, 2) + 500)
            Label9(1).Caption = "<---->"        'MUESTRA REPARTO DE LLAMADAS
                Else
                 '----------------
                   If recibido(0, 1) >= 128 Then  'vino solo caso > 500
                      Label9(0).Caption = "Caso " & Str$((recibido(0, 1) - 128) * 256 + recibido(0, 2) + 500)
                      Label9(1).Caption = "      "
                        Else
                        '----------------
                          If recibido(0, 1) >= 64 Then     'vino solo reparto de llamadas
                            Label9(0).Caption = "Caso " & Str$((recibido(0, 1) - 64) * 256 + recibido(0, 2))
                            Label9(1).Caption = "<---->"        'MUESTRA REPARTO DE LLAMADAS
                                Else
                                  Label9(0).Caption = "Caso " & Str$(recibido(0, 1) * 256 + recibido(0, 2))
                                  Label9(1).Caption = "      "        'MUESTRA REPARTO DE LLAMADAS
                          End If
                        '----------------
                   End If
                 '----------------
      End If
    '----------------
    End If
   '----------------

'******************************************************************************
 '    Muestra caso estación
      Label32.Caption = "Est " & Str$(recibido(0, 3))
    
'******************************************************************************
 '    Ve si hay falla en curso (EN ASCENSORES)
       For j = 1 To 4
       If status(j, 1) = 255 Then       'si posición=255 -> hubo falla de RX del ascensor al despacho
                       Label1(j - 1).Caption = "---------"
                       Label1(j - 1).BackColor = QBColor(12)
                       Label1(j - 1).ForeColor = QBColor(15)
                    Else
                        If status(j, 23) <> previewstatus(j, 23) Then
                            If status(j, 23) <> 255 Then        'SI NO HAY EVENTO -> ES 255 (NO ES 0 PORQUE 0 ES RESET)
                               ' Pone el evento en label1
                               Label1(j - 1).Caption = "Evento " & Str$(status(j, 23))
                               Label1(j - 1).BackColor = QBColor(12)
                               Label1(j - 1).ForeColor = QBColor(15)
                               ' Arma el dato a grabar en archivo de eventos
                               evento = Right$(Str$(status(j, 23)), Len(Str$(status(j, 23))) - 1)
                               ascensor = Right$(Str$(j), Len(Str$(j)) - 1)
                               fecha = Format(Date, "d/mm/yy")
                               hora = Format(Time, "h:mm")
                               piso = Right$(Str$(status(j, 1)), Len(Str$(status(j, 1))) - 1)
                               Write #6, ascensor, evento, piso, fecha, hora
                                 Else
                                    ' Arma "Estado OK" en label1
                                    Label1(j - 1).Caption = "Estado OK"
                                    Label1(j - 1).BackColor = QBColor(2)
                                    Label1(j - 1).ForeColor = QBColor(15)
                            End If
                       End If
       End If
       Next j
       
'******************************************************************************
 '    Ve si hay falla en curso (EN DESPACHO)
       If recibido(0, 92) <> previeweventoDPC Then
            ascensor = Right$(Str$(0), Len(Str$(0)) - 1)
            fecha = Format(Date, "d/mm/yy")
            hora = Format(Time, "h:mm")
            piso = Right$(Str$(0), Len(Str$(0)) - 1)
            If recibido(0, 92) <> 0 Then
                               Label23.Caption = "Evento " & Str$(recibido(0, 92))
                               Label23.ForeColor = QBColor(15)
                               Label23.BackColor = QBColor(12)
                               evento = Right$(Str$(recibido(0, 92)), Len(Str$(recibido(0, 92))) - 1)
                               Write #6, ascensor, evento, piso, fecha, hora
                                 Else
                                    Label23.Caption = "Estado OK"
                                    Label23.ForeColor = QBColor(15)
                                    Label23.BackColor = QBColor(2)
            End If
       End If
       
'******************************************************************************
'     Estado de CLS y CLB (OJO! No es lectura de entrada! Es estado para el programa!
        For j = 1 To 4
        If (Int(status(j, 16) / 128) Mod 2 = 0) Then
                                                Label24(j - 1).BackColor = QBColor(9)
                                              Else
                                                Label24(j - 1).BackColor = QBColor(12)
        End If
        Next j
        
        For j = 1 To 4
        If (Int(status(j, 16) / 64) Mod 2 = 0) Then
                                                Label25(j - 1).BackColor = QBColor(9)
                                              Else
                                                Label25(j - 1).BackColor = QBColor(12)
        End If
        Next j

'******************************************************************************
'      Estado de llamadas de cabina lado 1(registradas y anuladas)
        For p = 1 To 4
        For i = 26 To 29          'llamadas de cabina
'               LLAMADAS DE CABINA                        ANULADAS CABINA                               FALLA CABINA                     PROXIMA LLAMADA A ATENDER
        If (status(p, i) <> previewstatus(p, i)) Or (status(p, i + 24) <> previewstatus(p, i + 24)) Or (status(p, i + 48) <> previewstatus(p, i + 48)) Or (accionL1(p) <> previewaccionL1(p)) Then
        k = status(p, i)        'llamadas registradas
        m = status(p, i + 24)   'llamadas anuladas
        w = status(p, i + 48)   'llamadas con falla
        If grupo = 1 Then
                     r = aenviaraslc(i - 2)  'llamadas anuladas por PC - Usada para pintar de otro color
                                             'las que solo estan anuladas por teclado
                     Else
                     r = aenviaraslc((i - 16) + 8 * (p - 1))
        End If
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        n = m Mod 2
        m = Int(m / 2)
        u = r Mod 2
        r = Int(r / 2)
        x = w Mod 2
        w = Int(w / 2)
          
          If ((i - 26) * 8 + l) < 28 Then    'solo ve 28 llamadas (0 a 27)
            If j = 0 Then
                ' Marca con amarillo llamada de cabina colocada
                Label20((p - 1) * 28 + (i - 26) * 8 + l).BackColor = QBColor(14)
                ' Si la llamada recien se coloco, comienza a contar tiempo de llamada
                    If t_llam_cabina_act(p, (i - 26) * 8 + l) = 0 Then
                                            t_llam_cabina_act(p, (i - 26) * 8 + l) = Int(Timer)
                    End If
                        Else
                           'Si el tiempo de llamada no es 0 -> fue llamada colocada y borrada
                           If t_llam_cabina_act(p, (i - 26) * 8 + l) <> 0 Then
                              t_llam_cabina_act(p, (i - 26) * 8 + l) = Int(Timer) - t_llam_cabina_act(p, (i - 26) * 8 + l)
                              ' Despues de armar el string saca el espacio del signo a la izquierda
                              piso = Str$((i - 26) * 8 + l)
                              piso = Right$(piso, Len(piso) - 1)
                              tipo = "3"
                              tiempo = Str$(t_llam_cabina_act(p, (i - 26) * 8 + l))
                              tiempo = Right$(tiempo, Len(tiempo) - 1)
                              fecha = Format(Date, "d/mm/yy")
                              hora = Format(Time, "h:mm")
                              Write #5, piso, tipo, tiempo, fecha, hora
                              t_llam_cabina_act(p, (i - 26) * 8 + l) = 0
                           End If
                           If x = 1 Then
                              ' Marca llamada fallando en el ascensor correspondiente (celeste)
                              Label20((p - 1) * 28 + (i - 26) * 8 + l).BackColor = QBColor(9)
                                    Else
                                      If n = 1 Then         '1= llamada anulada informada por SLC
                                          If u = 1 Then     '1= llamada anulada en PC
                                                      ' Marca llamada anulada por PC en el ascensor correspondiente (rojo)
                                                      Label20((p - 1) * 28 + (i - 26) * 8 + l).BackColor = QBColor(12)
                                                   Else
                                                      ' Marca llamada anulada por Programador en el ascensor correspondiente (magenta)
                                                      Label20((p - 1) * 28 + (i - 26) * 8 + l).BackColor = QBColor(13)
                                          End If
                                              Else
                                               'Si la llamada no esta colocada ni anulada ni fallando la pinta de verde
                                               Label20((p - 1) * 28 + (i - 26) * 8 + l).BackColor = QBColor(2)
                                      End If
                           End If
            End If
          End If
        Next l
        
        End If
        
        Next i
        
'******************************************************************************
'      Estado de llamadas de cabina lado 2(registradas y anuladas)
        For i = 30 To 33          'llamadas de cabina
'               LLAMADAS DE CABINA                        ANULADAS CABINA                               FALLA CABINA                     PROXIMA LLAMADA A ATENDER
        If (status(p, i) <> previewstatus(p, i)) Or (status(p, i + 24) <> previewstatus(p, i + 24)) Or (status(p, i + 48) <> previewstatus(p, i + 48)) Or (accionL2(p) <> previewaccionL2(p)) Then
        k = status(p, i)        'llamadas registradas
        m = status(p, i + 32)   'llamadas anuladas
        w = status(p, i + 48)   'llamadas con falla
        If grupo = 1 Then
                     r = aenviaraslc(i - 2)  'llamadas anuladas por PC - Usada para pintar de otro color
                                             'las que solo estan anuladas por teclado
                     Else
                     r = aenviaraslc((i - 16) + 8 * (p - 1))
        End If
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        n = m Mod 2
        m = Int(m / 2)
        u = r Mod 2
        r = Int(r / 2)
        x = w Mod 2
        w = Int(w / 2)
          
          If ((i - 30) * 8 + l) < 28 Then    'solo ve 28 llamadas (0 a 27)
            If j = 0 Then
                ' Marca con amarillo llamada de cabina colocada
                Label33((p - 1) * 28 + (i - 30) * 8 + l).BackColor = QBColor(14)
                ' Si la llamada recien se coloco, comienza a contar tiempo de llamada
                    If t_llam_cabina_act(p, (i - 30) * 8 + l) = 0 Then
                                            t_llam_cabina_act(p, (i - 30) * 8 + l) = Int(Timer)
                    End If
                        Else
                           'Si el tiempo de llamada no es 0 -> fue llamada colocada y borrada
                           If t_llam_cabina_act(p, (i - 30) * 8 + l) <> 0 Then
                              t_llam_cabina_act(p, (i - 30) * 8 + l) = Int(Timer) - t_llam_cabina_act(p, (i - 30) * 8 + l)
                              ' Despues de armar el string saca el espacio del signo a la izquierda
                              piso = Str$((i - 30) * 8 + l)
                              piso = Right$(piso, Len(piso) - 1)
                              tipo = "3"
                              tiempo = Str$(t_llam_cabina_act(p, (i - 30) * 8 + l))
                              tiempo = Right$(tiempo, Len(tiempo) - 1)
                              fecha = Format(Date, "d/mm/yy")
                              hora = Format(Time, "h:mm")
                              Write #5, piso, tipo, tiempo, fecha, hora
                              t_llam_cabina_act(p, (i - 30) * 8 + l) = 0
                           End If
                           If x = 1 Then
                              ' Marca llamada fallando en el ascensor correspondiente (celeste)
                              Label33((p - 1) * 28 + (i - 30) * 8 + l).BackColor = QBColor(9)
                                    Else
                                      If n = 1 Then         '1= llamada anulada informada por SLC
                                          If u = 1 Then     '1= llamada anulada en PC
                                                      ' Marca llamada anulada por PC en el ascensor correspondiente (rojo)
                                                      Label33((p - 1) * 28 + (i - 30) * 8 + l).BackColor = QBColor(12)
                                                   Else
                                                      ' Marca llamada anulada por Programador en el ascensor correspondiente (magenta)
                                                      Label33((p - 1) * 28 + (i - 30) * 8 + l).BackColor = QBColor(13)
                                          End If
                                              Else
                                               'Si la llamada no esta colocada ni anulada ni fallando la pinta de verde
                                               Label33((p - 1) * 28 + (i - 30) * 8 + l).BackColor = QBColor(2)
                                      End If
                           End If
            End If
          End If
        Next l
        
        End If
        
        Next i
        
        
        'SI DEBE VER PRÓXIMA A ATENDER -> PINTA DE GRIS
        If Check8.Value = 1 Then
            If accionL1(p) > 192 Then        'atiende llamada de cabina
                    Label20((accionL1(p) - 192 - 1) + (p - 1) * 28).BackColor = QBColor(8) 'pone la llamada en gris
            End If
            If accionL2(p) > 192 Then        'atiende llamada de cabina
                    Label33((accionL2(p) - 192 - 1) + (p - 1) * 28).BackColor = QBColor(8) 'pone la llamada en gris
            End If
        End If
        
        Next p

'******************************************************************************
'      Estado de llamadas exteriores bajar lado 1
'      Si la llamada o la anulacion en todos los coches cambiaron, muestra cambio
        For i = 4 To 7
'                   LLAMADAS EXTERIORES                            ANULADAS BAJAR ASC 1                             ANULADAS BAJAR ASCENSOR 2                          ANULADAS BAJAR ASCENSOR 3                        ANULADAS BAJAR ASCENSOR 4
        If (llamexteriores1(i) <> previewllamadas1(i)) Or (status(1, i + 53) <> previewstatus(1, i + 53)) Or (status(2, i + 53) <> previewstatus(2, i + 53)) Or (status(3, i + 53) <> previewstatus(3, i + 53)) Or (status(4, i + 53) <> previewstatus(4, i + 53)) Then
        k = llamexteriores1(i)          'byte de llamada
        m = status(1, i + 54)           'byte de anulada ascensor 1
        n = status(2, i + 54)           'byte de anulada ascensor 2
        w = status(3, i + 54)           'byte de anulada ascensor 3
        w4 = status(4, i + 54)          'byte de anulada ascensor 4
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        r = m Mod 2
        m = Int(m / 2)
        s = n Mod 2
        n = Int(n / 2)
        z = w Mod 2
        z4 = w4 Mod 2
        w = Int(w / 2)
        w4 = Int(w4 / 2)
        
           If ((i - 4) * 8 + l) < 28 Then   'solo ve 28 llamadas (0 a 27)
               If j = 0 Then
                    ' Marca llamada bajar colocada
                    Picture4((i - 4) * 8 + l).Picture = LoadPicture("Pasajero.bmp")
                    If t_llam_bajar_act((i - 4) * 8 + l) = 0 Then
                               t_llam_bajar_act((i - 4) * 8 + l) = Int(Timer)
                    End If
                        Else
                           If t_llam_bajar_act((i - 4) * 8 + l) <> 0 Then
                              t_llam_bajar_act((i - 4) * 8 + l) = Int(Timer) - t_llam_bajar_act((i - 4) * 8 + l)
                              ' Despues de armar el string saca el espacio del signo a la izquierda
                              piso = Str$((i - 4) * 8 + l)
                              piso = Right$(piso, Len(piso) - 1)
                              tipo = "2"
                              tiempo = Str$(t_llam_bajar_act((i - 4) * 8 + l))
                              tiempo = Right$(tiempo, Len(tiempo) - 1)
                              fecha = Format(Date, "d/mm/yy")
                              hora = Format(Time, "h:mm")
                              Write #5, piso, tipo, tiempo, fecha, hora
                              t_llam_bajar_act((i - 4) * 8 + l) = 0
                           End If
                            'Si la llamada esta inhibida en todos los coches, la muestra inhibida
                            If (r = 1) And (s = 1) And (z = 1) And (z4 = 1) Then
                                         Picture4((i - 4) * 8 + l).Picture = LoadPicture("inhibida.bmp")
                                        Else
                                         Picture4((i - 4) * 8 + l).Picture = LoadPicture("sin llamada.bmp")
                            End If
            End If
         End If
         
        Next l
        End If
        Next i
  
'      Estado de llamadas exteriores bajar lado 2
'      Si la llamada o la anulacion en todos los coches cambiaron, muestra cambio
        For i = 4 To 7
'                   LLAMADAS EXTERIORES                            ANULADAS BAJAR ASC 1                     ANULADAS BAJAR ASCENSOR 2                      ANULADAS BAJAR ASCENSOR 3                        ANULADAS BAJAR ASCENSOR 4
        If (llamexteriores2(i) <> previewllamadas2(i)) Or (status(1, i + 65) <> previewstatus(1, i + 65)) Or (status(2, i + 65) <> previewstatus(2, i + 65)) Or (status(3, i + 65) <> previewstatus(3, i + 65)) Or (status(4, i + 65) <> previewstatus(4, i + 65)) Then
        k = llamexteriores2(i)          'byte de llamada
        m = status(1, i + 66)           'byte de anulada ascensor 1
        n = status(2, i + 66)           'byte de anulada ascensor 2
        w = status(3, i + 66)           'byte de anulada ascensor 3
        w4 = status(4, i + 66)          'byte de anulada ascensor 4
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        r = m Mod 2
        m = Int(m / 2)
        s = n Mod 2
        n = Int(n / 2)
        z = w Mod 2
        w = Int(w / 2)
        z4 = w4 Mod 2
        w4 = Int(w4 / 2)
        
           If ((i - 4) * 8 + l) < 28 Then   'solo ve 28 llamadas (0 a 27)
               If j = 0 Then
                    ' Marca llamada bajar colocada
                    Picture13((i - 4) * 8 + l).Picture = LoadPicture("Pasajero.bmp")
                    If t_llam_bajar_act((i - 4) * 8 + l) = 0 Then
                               t_llam_bajar_act((i - 4) * 8 + l) = Int(Timer)
                    End If
                        Else
                           If t_llam_bajar_act((i - 4) * 8 + l) <> 0 Then
                              t_llam_bajar_act((i - 4) * 8 + l) = Int(Timer) - t_llam_bajar_act((i - 4) * 8 + l)
                              ' Despues de armar el string saca el espacio del signo a la izquierda
                              piso = Str$((i - 4) * 8 + l)
                              piso = Right$(piso, Len(piso) - 1)
                              tipo = "2"
                              tiempo = Str$(t_llam_bajar_act((i - 4) * 8 + l))
                              tiempo = Right$(tiempo, Len(tiempo) - 1)
                              fecha = Format(Date, "d/mm/yy")
                              hora = Format(Time, "h:mm")
                              Write #5, piso, tipo, tiempo, fecha, hora
                              t_llam_bajar_act((i - 4) * 8 + l) = 0
                           End If
                            'Si la llamada esta inhibida en todos los coches, la muestra inhibida
                            If (r = 1) And (s = 1) And (z = 1) And (z4 = 1) Then
                                         Picture13((i - 4) * 8 + l).Picture = LoadPicture("inhibida.bmp")
                                        Else
                                         Picture13((i - 4) * 8 + l).Picture = LoadPicture("sin llamada.bmp")
                            End If
            End If
         End If
         
        Next l
        End If
        Next i

'******************************************************************************
' Si la mascara de asignación bajar lado 1 cambió o la llamada está anulada
' en cada ascensor, muestra cambio
        For p = 1 To 4
        For i = 38 To 41
'                   ASIGNADA BAJAR                           ANULADA BAJAR                                   LLAMADAS CON FALLA                       PROXIMA LLAMADA A ATENDER
        If (status(p, i) <> previewstatus(p, i)) Or (status(p, i + 20) <> previewstatus(p, i + 20)) Or (previewfalladas1(i - 38) <> fallaexteriores1(i - 38)) Or (accionL1(p) <> previewaccionL1(p)) Then
        k = status(p, i)                 'llamadas asignadas
        m = status(p, i + 20)            'llamadas anuladas (vienen de SLC - PC + Programador)
        w = fallaexteriores1(i - 34)     'llamadas con falla
        If grupo = 1 Then
                     r = aenviaraslc(i - 2)  'llamadas anuladas por PC - Usada para pintar de otro color
                                             'las que solo estan anuladas por teclado
                     Else
                     r = aenviaraslc(i + 8)
        End If
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        n = m Mod 2
        m = Int(m / 2)
        u = r Mod 2
        r = Int(r / 2)
        x = w Mod 2
        w = Int(w / 2)
        
        If ((i - 38) * 8 + l) < 28 Then     'solo ve 28 llamadas (0 a 27)
        If x = 1 Then               '1= llamada con falla
                ' Marca llamada con falla en el ascensor correspondiente (celeste)
                 Picture8((p - 1) * 28 + (i - 38) * 8 + l).Picture = LoadPicture("llamada bajar chica celeste.bmp")
                 Else
                   If n = 1 Then               '1= llamada anulada
                             If u = 1 Then       '1= llamada anulada por PC
                             ' Marca llamada anulada por PC en el ascensor correspondiente
                             Picture8((p - 1) * 28 + (i - 38) * 8 + l).Picture = LoadPicture("llamada bajar chica anulada.bmp")
                                      Else
                                       ' Marca llamada anulada por Programador en el ascensor correspondiente
'                                       Picture8((p - 1) * 28 + (i - 19) * 8 + l).Picture = LoadPicture("llamada bajar chica violeta.bmp")
                                       Picture8((p - 1) * 28 + (i - 38) * 8 + l).Picture = LoadPicture("llamada bajar chica naranja.bmp")
                             End If
                          Else
                            If j = 0 Then
                                     ' Marca llamada bajar colocada en el ascensor correspondiente
                                     Picture8((p - 1) * 28 + (i - 38) * 8 + l).Picture = LoadPicture("llamada bajar chica.bmp")
                                     Else
                                                Picture8((p - 1) * 28 + (i - 38) * 8 + l).Picture = LoadPicture("llamada negra.bmp")
                            End If
                   End If
        End If
        End If
        Next l
        End If
        Next i
        
        'SI DEBE VER PRÓXIMA A ATENDER -> PINTA DE GRIS
        If Check8.Value = 1 Then
                    If (accionL1(p) > 64) And (accionL1(p) < 128) Then  'atiende llamada bajar
                                       Picture8((accionL1(p) - 64 - 1) + (p - 1) * 28).Picture = LoadPicture("llamada bajar chica verde.bmp")
                    End If
        End If
                
        Next p
  
' Si la mascara de asignación bajar lado 2 cambió o la llamada está anulada
' en cada ascensor, muestra cambio
        For p = 1 To 4
        For i = 46 To 49
'                   ASIGNADA BAJAR                           ANULADA BAJAR                                  LLAMADAS CON FALLA                       PROXIMA LLAMADA A ATENDER
        If (status(p, i) <> previewstatus(p, i)) Or (status(p, i + 24) <> previewstatus(p, i + 24)) Or (previewfalladas2(i - 46) <> fallaexteriores2(i - 46)) Or (accionL2(p) <> previewaccionL2(p)) Then
        k = status(p, i)                 'llamadas asignadas
        m = status(p, i + 24)            'llamadas anuladas (vienen de SLC - PC + Programador)
        w = fallaexteriores2(i - 42)     'llamadas con falla
        If grupo = 1 Then
                     r = aenviaraslc(i - 2)  'llamadas anuladas por PC - Usada para pintar de otro color
                                             'las que solo estan anuladas por teclado
                     Else
                     r = aenviaraslc(i + 8)
        End If
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        n = m Mod 2
        m = Int(m / 2)
        u = r Mod 2
        r = Int(r / 2)
        x = w Mod 2
        w = Int(w / 2)
        
        If ((i - 46) * 8 + l) < 28 Then     'solo ve 28 llamadas (0 a 27)
        If x = 1 Then               '1= llamada con falla
                ' Marca llamada con falla en el ascensor correspondiente (celeste)
                 Picture14((p - 1) * 28 + (i - 46) * 8 + l).Picture = LoadPicture("llamada bajar chica celeste.bmp")
                 Else
                   If n = 1 Then               '1= llamada anulada
                             If u = 1 Then       '1= llamada anulada por PC
                             ' Marca llamada anulada por PC en el ascensor correspondiente
                             Picture14((p - 1) * 28 + (i - 46) * 8 + l).Picture = LoadPicture("llamada bajar chica anulada.bmp")
                                      Else
                                       ' Marca llamada anulada por Programador en el ascensor correspondiente
'                                       Picture8((p - 1) * 28 + (i - 19) * 8 + l).Picture = LoadPicture("llamada bajar chica violeta.bmp")
                                       Picture14((p - 1) * 28 + (i - 46) * 8 + l).Picture = LoadPicture("llamada bajar chica naranja.bmp")
                             End If
                          Else
                            If j = 0 Then
                                     ' Marca llamada bajar colocada en el ascensor correspondiente
                                     Picture14((p - 1) * 28 + (i - 46) * 8 + l).Picture = LoadPicture("llamada bajar chica.bmp")
                                     Else
                                                            Picture14((p - 1) * 28 + (i - 46) * 8 + l).Picture = LoadPicture("llamada negra.bmp")
                            End If
                   End If
        End If
        End If
        Next l
        End If
        Next i
        'SI DEBE VER PRÓXIMA A ATENDER -> PINTA DE GRIS
        If Check8.Value = 1 Then
                    If (accionL2(p) > 64) And (accionL2(p) < 128) Then  'atiende llamada bajar
                                       Picture14((accionL2(p) - 64 - 1) + (p - 1) * 28).Picture = LoadPicture("llamada bajar chica verde.bmp")
                    End If
        End If
        
        Next p
  
  
'******************************************************************************
'      Estado de llamadas exteriores subir lado 1
        For i = 0 To 3
'                   LLAMADAS EXTERIORES                            ANULADAS SUBIR ASC 1                       ANULADAS SUBIR ASC 2                          ANULADAS SUBIR ASC 3                    ANULADAS SUBIR ASC 4
        If (llamexteriores1(i) <> previewllamadas1(i)) Or (status(1, i + 54) <> previewstatus(1, i + 54)) Or (status(2, i + 54) <> previewstatus(2, i + 54)) Or (status(3, i + 54) <> previewstatus(3, i + 54)) Or (status(4, i + 54) <> previewstatus(4, i + 54)) Then
        k = llamexteriores1(i)          'byte de llamada
        m = status(1, i + 54)           'byte de anulada ascensor 1
        n = status(2, i + 54)           'byte de anulada ascensor 2
        w = status(3, i + 54)           'byte de anulada ascensor 3
        w4 = status(4, i + 54)          'byte de anulada ascensor 4
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        r = m Mod 2
        m = Int(m / 2)
        s = n Mod 2
        n = Int(n / 2)
        z = w Mod 2
        w = Int(w / 2)
        z4 = w4 Mod 2
        w4 = Int(w4 / 2)
        
          If ((i) * 8 + l) < 28 Then    'solo ve 28 llamadas (0 a 27)
            If j = 0 Then
                    Rem Marca llamada subir colocada
                    Picture5((i) * 8 + l).Picture = LoadPicture("Pasajero.bmp")
                    If t_llam_subir_act((i) * 8 + l) = 0 Then
                                            t_llam_subir_act((i) * 8 + l) = Int(Timer)
                    End If
                       Else
                         If t_llam_subir_act((i) * 8 + l) <> 0 Then
                           t_llam_subir_act((i) * 8 + l) = Int(Timer) - t_llam_subir_act((i) * 8 + l)
                           ' Despues de armar el string saca el espacio del signo a la izquierda
                           piso = Str$((i) * 8 + l)
                           piso = Right$(piso, Len(piso) - 1)
                           tipo = "1"
                           tiempo = Str$(t_llam_subir_act((i) * 8 + l))
                           tiempo = Right$(tiempo, Len(tiempo) - 1)
                           fecha = Format(Date, "d/mm/yy")
                           hora = Format(Time, "h:mm")
                           Write #5, piso, tipo, tiempo, fecha, hora
                           t_llam_subir_act((i) * 8 + l) = 0
                          End If
                            
                           'Si la llamada esta inhibida en todos los coches, la muestra inhibida
                            If (r = 1) And (s = 1) And (z = 1) And (z4 = 1) Then
                                         Picture5((i) * 8 + l).Picture = LoadPicture("inhibida.bmp")
                                        Else
                                         Picture5((i) * 8 + l).Picture = LoadPicture("sin llamada.bmp")
                            End If

           End If
         End If
        Next l
        End If
        Next i

'      Estado de llamadas exteriores subir lado 2
        For i = 0 To 3
'                   LLAMADAS EXTERIORES                            ANULADAS SUBIR ASC 1                       ANULADAS SUBIR ASC 2                          ANULADAS SUBIR ASC 3                            ANULADAS SUBIR ASC 4
        If (llamexteriores2(i) <> previewllamadas2(i)) Or (status(1, i + 66) <> previewstatus(1, i + 66)) Or (status(2, i + 66) <> previewstatus(2, i + 66)) Or (status(3, i + 66) <> previewstatus(3, i + 66)) Or (status(4, i + 66) <> previewstatus(4, i + 66)) Then
        k = llamexteriores2(i)          'byte de llamada
        m = status(1, i + 66)           'byte de anulada ascensor 1
        n = status(2, i + 66)           'byte de anulada ascensor 2
        w = status(3, i + 66)           'byte de anulada ascensor 3
        w4 = status(4, i + 66)          'byte de anulada ascensor 4
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        r = m Mod 2
        m = Int(m / 2)
        s = n Mod 2
        n = Int(n / 2)
        z = w Mod 2
        w = Int(w / 2)
        z4 = w4 Mod 2
        w4 = Int(w4 / 2)
        
          If ((i) * 8 + l) < 28 Then    'solo ve 28 llamadas (0 a 27)
            If j = 0 Then
                    Rem Marca llamada subir colocada
                    Picture12((i) * 8 + l).Picture = LoadPicture("Pasajero.bmp")
                    If t_llam_subir_act((i) * 8 + l) = 0 Then
                                            t_llam_subir_act((i) * 8 + l) = Int(Timer)
                    End If
                       Else
                         If t_llam_subir_act((i) * 8 + l) <> 0 Then
                           t_llam_subir_act((i) * 8 + l) = Int(Timer) - t_llam_subir_act((i) * 8 + l)
                           ' Despues de armar el string saca el espacio del signo a la izquierda
                           piso = Str$((i) * 8 + l)
                           piso = Right$(piso, Len(piso) - 1)
                           tipo = "1"
                           tiempo = Str$(t_llam_subir_act((i) * 8 + l))
                           tiempo = Right$(tiempo, Len(tiempo) - 1)
                           fecha = Format(Date, "d/mm/yy")
                           hora = Format(Time, "h:mm")
                           Write #5, piso, tipo, tiempo, fecha, hora
                           t_llam_subir_act((i) * 8 + l) = 0
                          End If
                            
                           'Si la llamada esta inhibida en todos los coches, la muestra inhibida
                            If (r = 1) And (s = 1) And (z = 1) And (z4 = 1) Then
                                         Picture12((i) * 8 + l).Picture = LoadPicture("inhibida.bmp")
                                        Else
                                         Picture12((i) * 8 + l).Picture = LoadPicture("sin llamada.bmp")
                            End If

           End If
         End If
        Next l
        End If
        Next i

'******************************************************************************
' Si la mascara de asignación subir lado 1 cambió o la llamada está anulada en cada ascensor, muestra cambio
        For p = 1 To 4
        For i = 34 To 37
'                   ASIGNADA SUBIR                           ANULADA SUBIR                           LLAMADAS CON FALLA                                   PROXIMA LLAMADA A ATENDER
        If (status(p, i) <> previewstatus(p, i)) Or (status(p, i + 20) <> previewstatus(p, i + 20)) Or (previewfalladas1(i - 34) <> fallaexteriores1(i - 34)) Or (accionL1(p) <> previewaccionL1(p)) Then
        k = status(p, i)
        m = status(p, i + 20)
        w = fallaexteriores1(i - 34)    'llamadas subir con falla
        
        If grupo = 1 Then
                     r = aenviaraslc(i - 2)  'llamadas anuladas por PC - Usada para pintar de otro color
                                             'las que solo estan anuladas por teclado
                     Else
                     r = aenviaraslc(i + 8)
        End If
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        n = m Mod 2
        m = Int(m / 2)
        u = r Mod 2
        r = Int(r / 2)
        x = w Mod 2
        w = Int(w / 2)
        
        'SI LA LLAMADA ES "CON FALLA" LA PINTA DE CELESTE
        '       SI NO -> SI ESTÁ ANULADA DE PC O PROGRAMADOR, LA PINTA DE ROJO O VIOLETA
        '           SI NO -> SI ESTÁ ASIGNADA -> AMARILLA
        '                   SI NO -> NEGRO
        If ((i - 34) * 8 + l) < 28 Then      'solo ve 28 llamadas (0 a 27)
        If x = 1 Then   'SI FALLA ->
                ' Marca llamada con falla en el ascensor correspondiente
                 Picture9((p - 1) * 28 + (i - 34) * 8 + l).Picture = LoadPicture("llamada subir chica celeste.bmp")
                 Else
                    If n = 1 Then               '1= llamada anulada
                              If u = 1 Then     '1= llamada anulada en PC
                                       ' Marca llamada anulada por PC en el ascensor correspondiente (roja)
                                       Picture9((p - 1) * 28 + (i - 34) * 8 + l).Picture = LoadPicture("llamada subir chica anulada.bmp")
                                       Else
                                        ' Marca llamada anulada por Programador en el ascensor correspondiente
                                        Picture9((p - 1) * 28 + (i - 34) * 8 + l).Picture = LoadPicture("llamada subir chica violeta.bmp")
                              End If
                             Else
                              If j = 0 Then    'llamada asignada
                                         ' Marca llamada subir colocada
                                         Picture9((p - 1) * 28 + (i - 34) * 8 + l).Picture = LoadPicture("llamada subir chica.bmp")
                                       Else
                                                    Picture9((p - 1) * 28 + (i - 34) * 8 + l).Picture = LoadPicture("llamada negra.bmp")
                              End If
                    End If
        End If
        End If
        Next l
        End If
        Next i
        
        'SI DEBE VER PRÓXIMA A ATENDER -> PINTA DE GRIS
        If Check8.Value = 1 Then
                    If (accionL1(p) > 128) And (accionL1(p) < 192) Then  'atiende llamada subir
                                       Picture9((accionL1(p) - 128 - 1) + (p - 1) * 28).Picture = LoadPicture("llamada subir chica verde.bmp")
                    End If
        End If
        
        Next p

' Si la mascara de asignación subir lado 2 cambió o la llamada está anulada en cada ascensor, muestra cambio
        For p = 1 To 4
        For i = 42 To 45
'                   ASIGNADA SUBIR                           ANULADA SUBIR                                   LLAMADAS CON FALLA                        PROXIMA LLAMADA A ATENDER
        If (status(p, i) <> previewstatus(p, i)) Or (status(p, i + 24) <> previewstatus(p, i + 24)) Or (previewfalladas2(i - 42) <> fallaexteriores2(i - 42)) Or (accionL2(p) <> previewaccionL2(p)) Then
        k = status(p, i)
        m = status(p, i + 24)
        w = fallaexteriores2(i - 42)    'llamadas subir con falla
        
        If grupo = 1 Then
                     r = aenviaraslc(i - 2)  'llamadas anuladas por PC - Usada para pintar de otro color
                                             'las que solo estan anuladas por teclado
                     Else
                     r = aenviaraslc(i + 8)
        End If
        
        For l = 0 To 7
        j = k Mod 2
        k = Int(k / 2)
        n = m Mod 2
        m = Int(m / 2)
        u = r Mod 2
        r = Int(r / 2)
        x = w Mod 2
        w = Int(w / 2)
        
        'SI LA LLAMADA ES "CON FALLA" LA PINTA DE CELESTE
        '       SI NO -> SI ESTÁ ANULADA DE PC O PROGRAMADOR, LA PINTA DE ROJO O VIOLETA
        '           SI NO -> SI ESTÁ ASIGNADA -> AMARILLA
        '                   SI NO -> NEGRO
        If ((i - 42) * 8 + l) < 28 Then      'solo ve 28 llamadas (0 a 27)
        If x = 1 Then   'SI FALLA ->
                ' Marca llamada con falla en el ascensor correspondiente
                 Picture15((p - 1) * 28 + (i - 42) * 8 + l).Picture = LoadPicture("llamada subir chica celeste.bmp")
                 Else
                    If n = 1 Then               '1= llamada anulada
                              If u = 1 Then     '1= llamada anulada en PC
                                       ' Marca llamada anulada por PC en el ascensor correspondiente (roja)
                                       Picture15((p - 1) * 28 + (i - 42) * 8 + l).Picture = LoadPicture("llamada subir chica anulada.bmp")
                                       Else
                                        ' Marca llamada anulada por Programador en el ascensor correspondiente
                                        Picture15((p - 1) * 28 + (i - 42) * 8 + l).Picture = LoadPicture("llamada subir chica violeta.bmp")
                              End If
                             Else
                              If j = 0 Then    'llamada asignada
                                         ' Marca llamada subir colocada
                                         Picture15((p - 1) * 28 + (i - 42) * 8 + l).Picture = LoadPicture("llamada subir chica.bmp")
                                       Else
                                                    Picture15((p - 1) * 28 + (i - 42) * 8 + l).Picture = LoadPicture("llamada negra.bmp")
                              End If
                    End If
        End If
        End If
        Next l
        End If
        Next i
                
        'SI DEBE VER PRÓXIMA A ATENDER -> PINTA DE GRIS
        If Check8.Value = 1 Then
                    If (accionL2(p) > 128) And (accionL2(p) < 192) Then  'atiende llamada subir
                                       Picture15((accionL1(p) - 128 - 1) + (p - 1) * 28).Picture = LoadPicture("llamada subir chica verde.bmp")
                    End If
        End If
        
        Next p

'******************************************************************************
        For j = 1 To 4
        For i = 0 To 81
        previewstatus(j, i) = status(j, i)
        Next i
        Next j
        
        For i = 0 To 7
        previewllamadas1(i) = llamexteriores1(i)
        previewfalladas1(i) = fallaexteriores1(i)
        previewllamadas2(i) = llamexteriores2(i)
        previewfalladas2(i) = fallaexteriores2(i)
        Next i
        
        If grupo <> 1 Then
                previeweventoDPC = recibido(0, 92)
        End If
    
        For i = 1 To 4
        previewaccionL1(i) = accionL1(i)
        previewaccionL2(i) = accionL2(i)
        Next i
    
End If      'end if de "If p=255 then" (marcador de que vino nueva info)

Else        ' else de "if recibido(93) = 170"

'      Limpia buffer de entrada porque no recibio EOF
        For i = MSComm1.InBufferCount To 0 Step -1
        s = MSComm1.Input
        Next i
        'Pinta marcador de espera de RX color amarillo
        Shape1.FillColor = QBColor(14)
        'Pinta marcador de RX recibida color negro
        'Shape2.FillColor = QBColor(0)
        'Pinta marcador de paquete recibido OK color negro
        Shape3.FillColor = QBColor(0)

End If          'end if de "If K <> 10 y paquetes=1"
End Select
    
'Pinta marcador de espera de RX color amarillo
Shape1.FillColor = QBColor(14)
'Pinta marcador de RX recibida color negro
'Shape2.FillColor = QBColor(0)
'Pinta marcador de paquete recibido OK color negro
'Shape3.FillColor = QBColor(0)
    
End Sub


'**********************************************************************

Private Sub Timer1_Timer()      'cada 5 segundos ve si com esta OK
If OKrecibido = 1 Then
                            Label5.Caption = "Com OK"
                            OKrecibido = 0
                        Else
                            Label5.Caption = "Sin Com"
                            Label5.BackColor = QBColor(12)      'color de fondo = rojo
                            Label5.ForeColor = QBColor(15)      'color de letras = blanco
                            
                            'Pinta marcador de espera de RX color amarillo
                            Shape1.FillColor = QBColor(14)
                            'Pinta marcador de RX recibida color negro
                            Shape2.FillColor = QBColor(0)
                            'Pinta marcador de paquete recibido OK color negro
                            Shape3.FillColor = QBColor(0)
                            
                            If SinCom = 0 Then
                                SinCom = 1
                                ascensor = Right$(Str$(10), Len(Str$(10)) - 1)  ' PREPARA PARA GRABAR EVENTO DE PERDIDA DE COM
                                fecha = Format(Date, "d/mm/yy")
                                hora = Format(Time, "h:mm")
                                piso = Right$(Str$(0), Len(Str$(0)) - 1)
                                evento = Right$(Str$(10), Len(Str$(10)) - 1)
                                Write #6, ascensor, evento, piso, fecha, hora
                            
                                ' LIMPIA TODAS LAS VARIABLES
                                'Limpia el buffer de entrada
                                For i = MSComm1.InBufferCount To 0 Step -1
                                s = MSComm1.Input
                                Next i

                                buffer = ""
                                OKrecibido = 0

                                For j = 1 To 4
                                For i = 0 To 80
                                previewstatus(j, i) = 0
                                Next i
                                Next j

                                For i = 0 To 7
                                llamexteriores1(i) = 0
                                previewllamadas1(i) = 0
                                previewfalladas1(i) = 55           'Cualquier valor
                                fallaexteriores1(i) = 0
                                llamexteriores2(i) = 0
                                previewllamadas2(i) = 0
                                previewfalladas2(i) = 55           'Cualquier valor
                                fallaexteriores2(i) = 0
                                Next i
                                
                                ' Carga cualquier cosa en preview de evento (porque si viene 0 no reconoce como nuevo
                                previewstatus(1, 23) = 255
                                previewstatus(2, 23) = 255
                                previewstatus(3, 23) = 255
                                previewstatus(4, 23) = 255
                                previeweventoDPC = 255
                                
                                For i = 1 To 4
                                For j = 1 To 28
                                t_llam_cabina_act(i, j) = 0
                                Next j
                                Next i
                                
                                
                                For i = 0 To 57
                                aenviaraslc(i) = 0
                                Next i
                            
                            End If
End If

End Sub
